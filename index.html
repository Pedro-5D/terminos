<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Astral</title>
    <link rel="icon" href="https://github.com/Pedro-5D/Zodiaco/blob/main/favicon.png" type="image/png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Cargar Babel sin mostrar advertencia -->
    <script>
        // Suprime la advertencia de Babel
        console.originalWarn = console.warn;
        console.warn = function(message) {
            if (message && message.indexOf && message.indexOf('You are using the in-browser Babel transformer') !== -1) {
                return;
            }
            console.originalWarn.apply(console, arguments);
        };
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Añadir librerías para descargar PDF e imagen -->
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5;
            font-family: Arial, sans-serif;
            color: #333;
        }
        
        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .left-section {
            flex: 1;
            min-width: 300px;
        }
        
        .right-section {
            flex: 0 0 350px;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .wheel-container { 
            width: 100%;
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            position: relative;
        }
        
        .wheel-svg {
            display: block;
            margin: 0 auto;
            width: 100%;
            height: auto;
        }
        
        .modern-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .toggle-options {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
        }

        .toggle-switch input[type="checkbox"] {
            height: 0;
            width: 0;
            visibility: hidden;
            position: absolute;
        }

        .toggle-switch label {
            cursor: pointer;
            text-indent: -9999px;
            width: 50px;
            height: 25px;
            background: #ddd;
            display: block;
            border-radius: 25px;
            position: relative;
            margin-right: 10px;
        }

        .toggle-switch label:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 19px;
            height: 19px;
            background: #fff;
            border-radius: 19px;
            transition: 0.3s;
        }

        .toggle-switch input:checked + label {
            background: #007bff;
        }

        .toggle-switch input:checked + label:after {
            left: calc(100% - 3px);
            transform: translateX(-100%);
        }

        .toggle-label {
            font-weight: 500;
            color: #555;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #0056b3;
        }
        
        .info-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .info-panel div {
            margin-bottom: 5px;
        }
        
        .planets-panel {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .planets-column {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .planets-column h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            color: #333;
        }
        
        .aspects-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .aspects-container h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            color: #333;
        }
        
        .aspect-list-item {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .aspect-list-item:hover {
            background-color: #f0f0f0;
        }
        
        .planet-list-item {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .planet-list-item:hover {
            background-color: #f0f0f0;
        }
        
        .interpretations-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
            flex-grow: 1;
            max-height: calc(100vh - 1800px); /* Altura máxima basada en altura de ventana */
            min-height: 1200px; /* Altura mínima para asegurar espacio suficiente */
        }
        
        .interpretation-section h3 {
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            color: #333;
        }
        
        .interpretation-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .interpretation-title {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .interpretation-content {
            color: #34495e;
            line-height: 1.5;
            font-size: 14px;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 15px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
        }
        
        .error-message {
            color: #dc3545;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
        }
        
        .star-symbol {
            color: #FFD700;
            text-shadow: 0 0 2px #000;
        }
        
        .physical-plane, 
        .astral-plane {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e9ecef;
        }
        
        .plane-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        /* Estilos para dignidades y planetas */
        .dignity-domicilio {
            color: #00AA00;
            font-weight: bold;
        }
        .dignity-exaltacion {
            color: #4444FF;
            font-weight: bold;
        }
        .dignity-peregrino {
            color: #888888;
        }
        .dignity-caida {
            color: #AA5500;
            font-weight: bold;
        }
        .dignity-exilio {
            color: #AA0000;
            font-weight: bold;
        }
        
        /* Estilos para retrograde y estacionario */
        .retrograde {
            color: #dc3545;
            font-weight: bold;
        }
        .stationary-retrograde {
            color: #fd7e14;
            font-weight: bold;
        }
        .stationary-direct {
            color: #20c997;
            font-weight: bold;
        }
        
        /* Estilos para los indicadores de carga */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilo para diferenciar carta natal y tránsitos */
        .natal-planet {
            stroke-width: 1;
        }
        .transit-planet {
            stroke-width: 1;
            stroke-dasharray: 2,2;
        }
        
        /* Estilos para los botones de descarga */
        .download-buttons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .download-btn {
            padding: 10px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #5a6268;
        }
        
        .download-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .download-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .btn-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .btn-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Ocultar botones si no hay datos */
        .download-buttons.hidden {
            display: none;
        }
        
        /* Estilos para términos astrológicos */
        .term-path {
            stroke: #333;
            stroke-width: 0.5;
            transition: opacity 0.3s;
        }

        .term-path:hover {
            opacity: 0.8;
        }

        .term-symbol {
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
            font-size: 10px;
        }

        /* Botón para mostrar/ocultar términos */
        .toggle-container {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .toggle-terms-btn {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .toggle-terms-btn:hover {
            background-color: #e0e0e0;
        }

        .toggle-terms-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }

        /* Panel de información de término */
        .term-info-panel {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .term-info-panel h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .term-info-content {
            display: flex;
            align-items: center;
        }

        .term-color-sample {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            border: 1px solid #333;
        }

        /* Leyenda de términos */
        .terms-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-right: 12px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 6px;
            border: 1px solid #333;
        }
        
        @media (max-width: 1000px) {
            .main-container {
                flex-direction: column;
            }
            
            .right-section {
                margin-left: 0;
            }
            
            .planets-panel {
                flex-direction: column;
            }
            
            .interpretations-container {
                max-height: 500px; /* Altura fija en dispositivos pequeños */
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
    console.log("Inicio del script Babel...");

const DIMENSIONS = {
    centerX: 300,
    centerY: 300,
    radius: 250,
    middleRadius: 180, // Radio para la carta externa (tránsitos)
    innerRadius: 110,  // Radio para la carta interna (natal)
    glyphRadius: 235,
    planetCircleRadiusNatal: 10, // Radio del círculo alrededor de los planetas natales
    planetCircleRadiusTransit: 10, // Radio del círculo alrededor de los planetas en tránsito
    
    // Nuevas dimensiones para términos astrológicos
    termsOuterRadius: 280, // Radio exterior del anillo de términos (fuera de la rueda principal)
    termsInnerRadius: 255, // Radio interior del anillo de términos
    termsSymbolRadius: 267  // Radio para ubicar los símbolos de términos
};

const SIGNS = [
    {name: 'ARIES', start: 354, length: 36, symbol: '♈', color: '#FFE5E5'},
    {name: 'TAURO', start: 30, length: 30, symbol: '♉', color: '#E5FFE5'},
    {name: 'GEMINI', start: 60, length: 30, symbol: '♊', color: '#FFFFE5'},
    {name: 'CANCER', start: 90, length: 30, symbol: '♋', color: '#E5FFFF'},
    {name: 'LEO', start: 120, length: 30, symbol: '♌', color: '#FFE5E5'},
    {name: 'VIRGO', start: 150, length: 36, symbol: '♍', color: '#E5FFE5'},
    {name: 'LIBRA', start: 186, length: 24, symbol: '♎', color: '#FFFFE5'},
    {name: 'ESCORPIO', start: 210, length: 30, symbol: '♏', color: '#E5FFFF'},
    {name: 'OFIUCO', start: 240, length: 12, symbol: '⛎', color: '#FFFFE5'},
    {name: 'SAGITARIO', start: 252, length: 18, symbol: '♐', color: '#FFE5E5'},
    {name: 'CAPRICORNIO', start: 270, length: 36, symbol: '♑', color: '#E5FFE5'},
    {name: 'ACUARIO', start: 306, length: 18, symbol: '♒', color: '#FFFFE5'},
    {name: 'PEGASO', start: 324, length: 6, symbol: '∩', color: '#E5FFFF'},
    {name: 'PISCIS', start: 330, length: 24, symbol: '♓', color: '#E5FFFF'}
];

// Definición de los términos planetarios (cada 6 grados)
const TERMS = {
    // Colores para los términos según los planetas regentes
    colors: {
        // Cada planeta tiene dos variantes de color
        "JUPITER_BLUE": "#E5FFFF",  // Azul pastel
        "JUPITER_RED": "#FFE5E5", // Rojo pastel
        "VENUS_YELLOW": "#FFFFE5",   // Amarillo pastel
        "VENUS_GREEN": "#E5FFE5",    // Verde pastel
        "MERCURIO_YELLOW": "#FFFFE5",  // Amarillo pastel
        "MERCURIO_GREEN": "#E5FFE5",  // Verde pastel
        "MARTE_RED": "#FFE5E5",      // Rojo pastel
        "MARTE_BLUE": "#E5FFFF"    // Azul pastel
        "SOL_ROJO": "#FFE5E5",  // Rojo pastel
        "SOL_VERDE": "#E5FFE5",  // Verde pastel
        "LUNA_AZUL": "#E5FFFF",      // Azul pastel
        "LUNA_AMARILLO": "#FFFFE5"    // Amarillo pastel
    },

    // Símbolos planetarios
    symbols: {
        "JUPITER": "♃",
        "VENUS": "♀",
        "MERCURIO": "☿",
        "MARTE": "♂",
        "SATURNO": "♄"
    },

    // Para cada signo, definimos términos cada 6 grados aproximadamente
    "ARIES": [
        { planet: "MARTE_BLUE", start: 0, end: 6 },
        { planet: "MERCURIO_YELLOW", start: 6, end: 12 },
        { planet: "SOL_ROJO", start: 12, end: 18 },
        { planet: "VENUS_GREEN", start: 18, end: 24 },
        { planet: "MARTE_RED", start: 24, end: 30 },
        { planet: "JUPITER_RED", start: 30, end: 36 }
    ],
    "TAURO": [
        { planet: "LUNA_AZUL", start: 0, end: 6 },
        { planet: "VENUS_YELLOW", start: 6, end: 12 },
        { planet: "SOL_ROJO", start: 12, end: 18 },
        { planet: "MERCURIO_GREEN", start: 18, end: 24 },
        { planet: "SOL_ROJO", start: 24, end: 30 }
    ],
    "GEMINI": [
        { planet: "SOL_ROJO", start: 0, end: 6 },
        { planet: "LUNA_AZUL", start: 6, end: 12 },
        { planet: "MERCURIO_YELLOW", start: 12, end: 18 },
        { planet: "MARTE_RED", start: 18, end: 24 },
        { planet: "SOL_VERDE", start: 24, end: 30 }
    ],
    "CANCER": [
        { planet: "SOL_ROJO", start: 0, end: 6 },
        { planet: "JUPITER_RED", start: 6, end: 12 },
        { planet: "MARTE_BLUE", start: 12, end: 18 },
        { planet: "LUNA_AMARILLO", start: 18, end: 24 },
        { planet: "MARTE_RED", start: 24, end: 30 }
    ],
    "LEO": [
        { planet: "MERCURIO_GREEN", start: 0, end: 6 },
        { planet: "SOL_ROJO", start: 6, end: 12 },
        { planet: "SOL_ROJO", start: 12, end: 18 },
        { planet: "LUNA_AZUL", start: 18, end: 24 },
        { planet: "MERCURIO_YELLOW", start: 24, end: 30 }
    ],
    "VIRGO": [
        { planet: "MARTE_RED", start: 0, end: 6 },
        { planet: "SOL_VERDE", start: 6, end: 12 },
        { planet: "SOL_ROJO", start: 12, end: 18 },
        { planet: "JUPITER_RED", start: 18, end: 24 },
        { planet: "MARTE_BLUE", start: 24, end: 30 },
        { planet: "LUNA_AMARILLO", start: 30, end: 36 }
    ],
    "LIBRA": [
        { planet: "MARTE_RED", start: 0, end: 6 },
        { planet: "MERCURIO_GREEN", start: 6, end: 12 },
        { planet: "MARTE_RED", start: 12, end: 18 },
        { planet: "MARTE_RED", start: 18, end: 24 }
    ],
    "ESCORPIO": [
        { planet: "MARTE_BLUE", start: 0, end: 6 },
        { planet: "MERCURIO_YELLOW", start: 6, end: 12 },
        { planet: "SOL_ROJO", start: 12, end: 18 },
        { planet: "VENUS_GREEN", start: 18, end: 24 },
        { planet: "MARTE_RED", start: 24, end: 30 }
    ],
    "OFIUCO": [
        { planet: "JUPITER_RED", start: 0, end: 6 },
        { planet: "LUNA_AZUL", start: 6, end: 12 }
    ],
    "SAGITARIO": [
        { planet: "VENUS_YELLOW", start: 0, end: 6 },
        { planet: "SOL_ROJO", start: 6, end: 12 },
        { planet: "MERCURIO_GREEN", start: 12, end: 18 }
    ],
    "CAPRICORNIO": [
        { planet: "SOL_ROJO", start: 0, end: 6 },
        { planet: "SOL_ROJO", start: 6, end: 12 },
        { planet: "LUNA_AZUL", start: 12, end: 18 },
        { planet: "MERCURIO_YELLOW", start: 18, end: 24 },
        { planet: "MARTE_RED", start: 24, end: 30 },
        { planet: "SOL_VERDE", start: 30, end: 36 }
    ],
    "ACUARIO": [
        { planet: "SOL_ROJO", start: 0, end: 6 },
        { planet: "JUPITER_RED", start: 6, end: 12 },
        { planet: "MARTE_BLUE", start: 12, end: 18 }
    ],
    "PEGASO": [
        { planet: "LUNA_AMARILLO", start: 0, end: 6 }
    ],
    "PISCIS": [
        { planet: "MARTE_RED", start: 0, end: 6 },
        { planet: "MERCURIO_GREEN", start: 6, end: 12 },
        { planet: "MARTE_RED", start: 12, end: 18 },
        { planet: "MARTE_RED", start: 18, end: 24 }
    ]
};

const PLANET_SYMBOLS = {
    'DSC': 'Dc',
    'IC': 'Ic',
    'PARTE_FORTUNA': 'Pf',
    'PARTE_ESPIRITU': 'Pe',
    'ASC': 'Ac',
    'MC': 'Mc',
    'URANO': '♅',
    'NEPTUNO': '♆',
    'PLUTÓN': '♇',
    'SOL': '☉',
    'LUNA': '☽',
    'MERCURIO': '☿',
    'VENUS': '♀',
    'MARTE': '♂',
    'JÚPITER': '♃',
    'SATURNO': '♄'
};

const ASPECTS = {
    CONJUNCTION: { angle: 0, orb: 2, color: '#000080', name: 'Armónico Relevante' },
    SEIS: { angle: 6, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    DOCE: { angle: 12, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    DIECIOCHO: { angle: 18, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    VEINTICUATRO: { angle: 24, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    TREINTA: { angle: 30, orb: 2, color: '#FF0000', name: 'Inarmónico Relevante' },
    TREINTAYSEIS: { angle: 36, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CUARENTAYDOS: { angle: 42, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    CUARENTAYOCHO: { angle: 48, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CICUENTAYCUATRO: { angle: 54, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    SEXTILE: { angle: 60, orb: 2, color: '#000080', name: 'Armónico Relevante' },
    SESENTAYSEIS: { angle: 66, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    QUINTILE: { angle: 72, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    SETENTAYOCHO: { angle: 78, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    OCHENTAYCUATRO: { angle: 84, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    SQUARE: { angle: 90, orb: 2, color: '#FF0000', name: 'Inarmónico Relevante' },
    NOVENTAYSEIS: { angle: 96, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CIENTODOS: { angle: 102, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    CIENTOOCHO: { angle: 108, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CIENTOCATORCE: { angle: 114, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    TRINE: { angle: 120, orb: 2, color: '#000080', name: 'Armónico Relevante' },
    CIENTOVEINTISEIS: { angle: 126, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    CIENTOTREINTAYDOS: { angle: 132, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CIENTOTREINTAYOCHO: { angle: 138, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    CIENTOCUARENTAYCUATRO: { angle: 144, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    QUINCUNX: { angle: 150, orb: 2, color: '#FF0000', name: 'Inarmónico Relevante' },
    CIENTOCINCUENTAYSEIS: { angle: 156, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CIENTOSESENTAYDOS: { angle: 162, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    CIENTOSESENTAYOCHO: { angle: 168, orb: 2, color: '#ADD8E6', name: 'Armónico' },
    CIENTOSETENTAYCUATRO: { angle: 174, orb: 2, color: '#ffff00', name: 'Inarmónico' },
    OPPOSITION: { angle: 180, orb: 2, color: '#000080', name: 'Armónico Relevante' }
};

const COLORS = {
    RED: '#FF0000',
    GREEN: '#00FF00',
    BLUE: '#0000FF',
    YELLOW: '#FFFF00'
};

// Define colores pastel para los planetas
const PASTEL_COLORS = {
    RED: '#FF9999',     // Pastel red
    GREEN: '#99FF99',   // Pastel green
    BLUE: '#9999FF',    // Pastel blue
    YELLOW: '#FFFF99',  // Pastel yellow
    ORANGE: '#FFD699',  // Pastel orange
    PURPLE: '#D699FF',  // Pastel purple
    CYAN: '#99FFFF',    // Pastel cyan
    PINK: '#FF99FF',    // Pastel pink
    GRAY: '#E0E0E0'     // Light gray for cardinal points
};

const DIGNIDAD_LABELS = {
    'domicilio': 'Domicilio',
    'exaltacion': 'Exaltación',
    'peregrino': 'Peregrino',
    'caida': 'Caída',
    'exilio': 'Exilio'
};

const FIXED_STARS = [
            {
                name: "Aldebaran",
                longitude_J2000: 69.00,
                effect: "Honor, inteligencia y riqueza",
                filePath: "https://www.izarren.top/aldebaran",
                magnitude: 12
            },
            {
                name: "Antares",
                longitude_J2000: 249.18,
                effect: "Impulsividad y éxito arriesgado",
                filePath: "https://www.izarren.top/antares",
                magnitude: 12
            },
            {
                name: "Regulus",
                longitude_J2000: 148.51,
                effect: "Poder, éxito y honores",
                filePath: "https://www.izarren.top/regulus",
                magnitude: 12
            },
            {
                name: "Spica",
                longitude_J2000: 203.52,
                effect: "Beneficios a través del arte y ciencia",
                filePath: "https://www.izarren.top/spica",
                magnitude: 12
            },
            {
                name: "Sirius",
                longitude_J2000: 102.30,
                effect: "Honor, renombre y riqueza",
                filePath: "https://www.izarren.top/sirio",
                magnitude: 12
            },
            {
                name: "Algol",
                longitude_J2000: 56.3,
                effect: "Desafíos y transformación",
                filePath: "https://www.izarren.top/algol",
                magnitude: 12
            },
            {
                name: "Capella",
                longitude_J2000: 81.40,
                effect: "Honor y riqueza",
                filePath: "https://www.izarren.top/capella",
                magnitude: 12
            },
            {
                name: "Vega",
                longitude_J2000: 284.03,
                effect: "Beneficios artísticos y creatividad",
                filePath: "https://www.izarren.top/vega",
                magnitude: 12
            },
            {
                name: "Pollux",
                longitude_J2000: 113.31,
                effect: "Éxito atlético y marcial",
                filePath: "https://www.izarren.top/pollux",
                magnitude: 12
            },
            {
                name: "Fomalhaut",
                longitude_J2000: 333.0,
                effect: "Éxito espiritual y místico",
                filePath: "https://www.izarren.top/fomalhaut",
                magnitude: 6
            },
            {
                name: "Proción",
                longitude_J2000: 114.19,
                effect: "Éxito y honores a través del esfuerzo",
                filePath: "https://www.izarren.top/procyon",
                magnitude: 12
            },
            {
                name: "Mira Ceti",
                longitude_J2000: 31.03,
                effect: "Misterio y transformación espiritual",
                filePath: "https://www.izarren.top/mira-de-ceti",
                magnitude: 6
            },
            {
                name: "Zaurak",
                longitude_J2000: 53.22,
                effect: "Sabiduría y paciencia",
                filePath: "https://www.izarren.top/zaurak",
                magnitude: 6
            },
            {
                name: "Alkakurops",
                longitude_J2000: 212.43,
                effect: "Protección y habilidad estratégica",
                filePath: "https://www.izarren.top/alkalurops",
                magnitude: 6
            },
            {
                name: "Markab",
                longitude_J2000: 353.7,
                effect: "Viajes y aventuras exitosas",
                filePath: "https://www.izarren.top/markab",
                magnitude: 6
            },
            {
                name: "Princeps",
                longitude_J2000: 212.41,
                effect: "Liderazgo y nobleza",
                filePath: "https://www.izarren.top/princeps",
                magnitude: 6
            },
            {
                name: "Agena",
                longitude_J2000: 234.2,
                effect: "Honor y reconocimiento público",
                filePath: "https://www.izarren.top/agena",
                magnitude: 6
            },
            {
                name: "Alcione",
                longitude_J2000: 59.31,
                effect: "Visión espiritual y experiencias místicas",
                filePath: "https://www.izarren.top/alcyone",
                magnitude: 12
            },
            {
                name: "Alkaid",
                longitude_J2000: 177.1,
                effect: "Honores militares y liderazgo",
                filePath: "https://www.izarren.top/alkaid",
                magnitude: 12
            },
            {
                name: "Gienah",
                longitude_J2000: 174.5,
                effect: "Capacidad oratoria y percepción aguda",
                filePath: "https://www.izarren.top/gienah",
                magnitude: 12
            },
            {
                name: "Arcturus",
                longitude_J2000: 204.15,
                effect: "Éxito a través de la autodeterminación",
                filePath: "https://www.izarren.top/arcturus",
                magnitude: 12
            },
            {
                name: "Alphecca",
                longitude_J2000: 221.52,
                effect: "Dones artísticos y diplomacia",
                filePath: "https://www.izarren.top/alphecca",
                magnitude: 12
            },
            {
                name: "Deneb Algedi",
                longitude_J2000: 303.5,
                effect: "Posición de autoridad y justicia",
                filePath: "https://www.izarren.top/deneb-algedi",
                magnitude: 12
            },
            {
                name: "Acamar",
                longitude_J2000: 22.47,
                effect: "Éxito en cargos públicos",
                filePath: "https://www.izarren.top/acamar",
                magnitude: 6
            },
            {
                name: "Avior",
                longitude_J2000: 172.41,
                effect: "Mensajero divino",
                filePath: "https://www.izarren.top/avior",
                magnitude: 6
            },
            {
                name: "Deneb Kaitos",
                longitude_J2000: 2.06,
                effect: "Provoca cambio obligatorio",
                filePath: "https://www.izarren.top/deneb-kaitos",
                magnitude: 6
            },
            {
                name: "Altair",
                longitude_J2000: 301.18,
                effect: "Culpa de derramamiento de sangre",
                filePath: "https://www.izarren.top/altair",
                magnitude: 6
            },
            {
                name: "Thuban",
                longitude_J2000: 156.36,
                effect: "El Sutil",
                filePath: "https://www.izarren.top/thuban",
                magnitude: 6
            },
            {
                name: "Skat",
                longitude_J2000: 338.24,
                effect: "Provoca cambio obligatorio",
                filePath: "https://www.izarren.top/skat",
                magnitude: 6
            },
            {
                name: "Biham",
                longitude_J2000: 336.21,
                effect: "Los camellos sedientos",
                filePath: "https://www.izarren.top/biham",
                magnitude: 6
            },
            {
                name: "Dubhe",
                longitude_J2000: 134.44,
                effect: "Calisto",
                filePath: "https://www.izarren.top/dubhe",
                magnitude: 6
            },
            {
                name: "Cursa",
                longitude_J2000: 74.48,
                effect: "El pozo dorado",
                filePath: "https://www.izarren.top/cursa",
                magnitude: 6
            },
            {
                name: "Betelgeuse",
                longitude_J2000: 88.17,
                effect: "Elevación social",
                filePath: "https://www.izarren.top/betelgeuse",
                magnitude: 6
            },
            {
                name: "Bellatrix",
                longitude_J2000: 89.29,
                effect: "Estrella amazona",
                filePath: "https://www.izarren.top/bellatrix",
                magnitude: 6
            },
            {
                name: "Acubens",
                longitude_J2000: 133.11,
                effect: "El refugio del escondite",
                filePath: "https://www.izarren.top/acubens",
                magnitude: 6
            },
            {
                name: "Adhafera",
                longitude_J2000: 147.06,
                effect: "La pira funeraria",
                filePath: "https://www.izarren.top/adhafera",
                magnitude: 6
            },
            {
                name: "Acrab",
                longitude_J2000: 242.43,
                effect: "Malevolencia extrema",
                filePath: "https://www.izarren.top/acrab",
                magnitude: 6
            },
            {
                name: "Al Haud",
                longitude_J2000: 126.48,
                effect: "Persecución de la sabiduría",
                filePath: "https://www.izarren.top/al-haud",
                magnitude: 6
            },
            {
                name: "Al Hecka",
                longitude_J2000: 84.19,
                effect: "El cuerno sur del toro",
                filePath: "https://www.izarren.top/al-hecka",
                magnitude: 6
            },
            {
                name: "Anser",
                longitude_J2000: 299.22,
                effect: "Profetiza",
                filePath: "https://www.izarren.top/anser",
                magnitude: 6
            },
            {
                name: "Ascella",
                longitude_J2000: 283.10,
                effect: "Da buena fortuna y felicidad",
                filePath: "https://www.izarren.top/ascella",
                magnitude: 6
            },
            {
                name: "Dabih",
                longitude_J2000: 303.34,
                effect: "Propagación del conocimiento",
                filePath: "https://www.izarren.top/dabih",
                magnitude: 6
            },
            {
                name: "El kophrah",
                longitude_J2000: 153.12,
                effect: "El salto de la gacela",
                filePath: "https://www.izarren.top/el-kophrah",
                magnitude: 6
            },
            {
                name: "Kochab",
                longitude_J2000: 132.51,
                effect: "El emperador",
                filePath: "https://www.izarren.top/kochab",
                magnitude: 6
            },
            {
                name: "Kraz",
                longitude_J2000: 196.54,
                effect: "El emperador",
                filePath: "https://www.izarren.top/kraz",
                magnitude: 6
            },
            {
                name: "Menkar",
                longitude_J2000: 44.37,
                effect: "Elevación social",
                filePath: "https://www.izarren.top/menkar",
                magnitude: 6
            },
            {
                name: "Mirach",
                longitude_J2000: 29.56,
                effect: "El lado de la mujer encadenada",
                filePath: "https://www.izarren.top/mirach",
                magnitude: 6
            },
            {
                name: "Miram",
                longitude_J2000: 58.14,
                effect: "Veneno mortal",
                filePath: "https://www.izarren.top/miram",
                magnitude: 6
            },
            {
                name: "Misam",
                longitude_J2000: 57.13,
                effect: "Cura y resucita",
                filePath: "https://www.izarren.top/misam",
                magnitude: 6
            },
            {
                name: "Muscida",
                longitude_J2000: 113.18,
                effect: "Don de lenguas",
                filePath: "https://www.izarren.top/muscida",
                magnitude: 6
            },
            {
                name: "Scheat",
                longitude_J2000: 358.54,
                effect: "Peligro por ahogamiento o sofocación",
                filePath: "https://www.izarren.top/scheat",
                magnitude: 6
            },
            {
                name: "Schedar",
                longitude_J2000: 37.19,
                effect: "El collar de Armonía",
                filePath: "https://www.izarren.top/schedar",
                magnitude: 6
            },
            {
                name: "Seginus",
                longitude_J2000: 197.12,
                effect: "Facilidad para astrología, leyes",
                filePath: "https://www.izarren.top/seginus",
                magnitude: 6
            },
            {
                name: "Vindemiatrix",
                longitude_J2000: 189.29,
                effect: "Hierba alucinogena",
                filePath: "https://www.izarren.top/vindemiatrix",
                magnitude: 6
            },
            {
                name: "Zavijava",
                longitude_J2000: 176.42,
                effect: "Buen vendedor, ejecutivo, gerente o comandante subordinado",
                filePath: "https://www.izarren.top/zavijava",
                magnitude: 6
            },
            {
                name: "Zibal",
                longitude_J2000: 43.21,
                effect: "Nido de avestruz",
                filePath: "https://www.izarren.top/zibal",
                magnitude: 6
            },
            {
                name: "Zosma",
                longitude_J2000: 160.51,
                effect: "Gran inteligencia",
                filePath: "https://www.izarren.top/zosma",
                magnitude: 6
            },
            {
                name: "Tolimán",
                longitude_J2000: 239.04,
                effect: "Posición de honor y poder",
                filePath: "https://www.izarren.top/rigel-centauro",
                magnitude: 6
            },
            {
                name: "Tarazed",
                longitude_J2000: 300.28,
                effect: "Fortaleza y resistencia",
                filePath: "https://www.izarren.top/tarazed",
                magnitude: 6
            },
            {
                name: "Alterf",
                longitude_J2000: 137.25,
                effect: "La mirada",
                filePath: "https://www.izarren.top/alterf",
                magnitude: 6
            },
            {
                name: "Deneb Adige",
                longitude_J2000: 334.51,
                effect: "Habilidades artísticas y misticismo",
                filePath: "https://www.izarren.top/deneb-adige",
                magnitude: 6
            },
            {
                name: "Psi Osa Mayor",
                longitude_J2000: 167.21,
                effect: "Inspiración y guía espiritual",
                filePath: "https://www.izarren.top/psi-osa-mayor",
                magnitude: 6
            },
            {
                name: "Etamin",
                longitude_J2000: 271.45,
                effect: "Sabiduría y protección",
                filePath: "https://www.izarren.top/etamin",
                magnitude: 6
            },
            {
                name: "Alderamin",
                longitude_J2000: 308.37,
                effect: "Liderazgo y autoridad",
                filePath: "https://www.izarren.top/alderamin",
                magnitude: 6
            },
            {
                name: "Alpheratz",
                longitude_J2000: 14.11,
                effect: "Independencia y libertad",
                filePath: "https://www.izarren.top/alpheratz",
                magnitude: 6
            },
            {
                name: "Algenib",
                longitude_J2000: 9.45,
                effect: "Ambición y determinación",
                filePath: "https://www.izarren.top/algenib",
                magnitude: 6
            },
            {
                name: "Hamal",
                longitude_J2000: 33.10,
                effect: "Independencia y liderazgo",
                filePath: "https://www.izarren.top/hamal",
                magnitude: 6
            },
            {
                name: "Mintaka",
                longitude_J2000: 84.05,
                effect: "Éxito y protección",
                filePath: "https://www.izarren.top/mintaka",
                magnitude: 6
            },
            {
                name: "Alnilam",
                longitude_J2000: 85.11,
                effect: "Fortuna súbita",
                filePath: "https://www.izarren.top/alnilam",
                magnitude: 6
            },
            {
                name: "Alnitak",
                longitude_J2000: 86.18,
                effect: "Protección y honor",
                filePath: "https://www.izarren.top/alnitak",
                magnitude: 6
            },
            {
                name: "Castor",
                longitude_J2000: 113.17,
                effect: "Inteligencia y escritura",
                filePath: "https://www.izarren.top/castor",
                magnitude: 6
            },
            {
                name: "Merak",
                longitude_J2000: 153.11,
                effect: "Peligro de violencia",
                filePath: "https://www.izarren.top/merak",
                magnitude: 6
            },
            {
                name: "Alioth",
                longitude_J2000: 166.44,
                effect: "Persistencia y tenacidad",
                filePath: "https://www.izarren.top/alioth",
                magnitude: 6
            },
            {
                name: "Phecda",
                longitude_J2000: 157.32,
                effect: "Guardián y protector",
                filePath: "https://www.izarren.top/phecda",
                magnitude: 6
            },
            {
                name: "Alkes",
                longitude_J2000: 127.25,
                effect: "Sabiduría espiritual",
                filePath: "https://www.izarren.top/alkes",
                magnitude: 6
            },    
            {
                name: "Diadem",
                longitude_J2000: 203.17,
                effect: "Dignidad y honor",
                filePath: "https://www.izarren.top/diadem",
                magnitude: 6
            },
            {
                name: "Menkent",
                longitude_J2000: 231.11,
                effect: "Logros intelectuales",
                filePath: "https://www.izarren.top/menkent",
                magnitude: 6
            },
            {
                name: "Suhail",
                longitude_J2000: 223.22,
                effect: "Viajes y expansión",
                filePath: "https://www.izarren.top/suhail",
                magnitude: 6
            },
            {
                name: "Miaplacidus",
                longitude_J2000: 221.39,
                effect: "Éxito en navegación",
                filePath: "https://www.izarren.top/miaplacidus",
                magnitude: 6
            },
            {
                name: "Al Risha",
                longitude_J2000: 28.38,
                effect: "Unión espiritual",
                filePath: "https://www.izarren.top/al-risha",
                magnitude: 6
            },
            {
                name: "Alcor",
                longitude_J2000: 169.21,
                effect: "Pruebas de lealtad",
                filePath: "https://www.izarren.top/alcor",
                magnitude: 6
            },
            {
                name: "Zuben Elgenubi",
                longitude_J2000: 224.43,
                effect: "Beneficios por servicio",
                filePath: "https://www.izarren.top/zuben-elgenubi",
                magnitude: 6
            },
            {
                name: "Zuben Elschemali",
                longitude_J2000: 235.27,
                effect: "Beneficios por justicia",
                filePath: "https://www.izarren.top/zubenelschemali",
                magnitude: 6
            },
            {
                name: "Acumen",
                longitude_J2000: 248.49,
                effect: "Ataques y defensas",
                filePath: "https://www.izarren.top/acumen",
                magnitude: 6
            },
            {
                name: "Aculeus",
                longitude_J2000: 247.11,
                effect: "Ataque y defensa",
                filePath: "https://www.izarren.top/aculeus",
                magnitude: 6
            },
            {
                name: "Algorab",
                longitude_J2000: 176.51,
                effect: "Destructivo y maligno",
                filePath: "https://www.izarren.top/algorab",
                magnitude: 6
            },
            {
                name: "Menkalinan",
                longitude_J2000: 89.41,
                effect: "Buena fortuna",
                filePath: "https://www.izarren.top/menkalinan",
                magnitude: 6
            },
            {
                name: "Alfard",
                longitude_J2000: 131.44,
                effect: "Cualidades de liderazgo",
                filePath: "https://www.izarren.top/alfard",
                magnitude: 6
            },
            {
                name: "Algieba",
                longitude_J2000: 149.49,
                effect: "Riqueza y generosidad",
                filePath: "https://www.izarren.top/algieba",
                magnitude: 6
            },
            {
                name: "Meissa",
                longitude_J2000: 83.21,
                effect: "Protección divina",
                filePath: "https://www.izarren.top/meissa",
                magnitude: 6
            },
            {
                name: "Saiph",
                longitude_J2000: 96.19,
                effect: "Comando y liderazgo",
                filePath: "https://www.izarren.top/saiph",
                magnitude: 6
            },
            {
                name: "Phact",
                longitude_J2000: 104.41,
                effect: "Logros duraderos",
                filePath: "https://www.izarren.top/phact",
                magnitude: 6
            },
            {
                name: "Wezen",
                longitude_J2000: 107.11,
                effect: "Protección en viajes",
                filePath: "https://www.izarren.top/wezen",
                magnitude: 6
            },
            {
                name: "Aludra",
                longitude_J2000: 112.22,
                effect: "Buen juicio",
                filePath: "https://www.izarren.top/aludra",
                magnitude: 6
            },
            {
                name: "Alula Australis",
                longitude_J2000: 169.21,
                effect: "Habilidades curativas",
                filePath: "https://www.izarren.top/alula-australis",
                magnitude: 6
            },
            {
                name: "Alula Borealis",
                longitude_J2000: 168.52,
                effect: "Liderazgo espiritual",
                filePath: "https://www.izarren.top/alula-borealis",
                magnitude: 6
            },
            {
                name: "Tania Australis",
                longitude_J2000: 167.43,
                effect: "Persistencia",
                filePath: "https://www.izarren.top/tania-australis",
                magnitude: 6
            },
            {
                name: "Tania Borealis",
                longitude_J2000: 166.12,
                effect: "Determinación",
                filePath: "https://www.izarren.top/tania-borealis",
                magnitude: 6
            },
            {
                name: "Talitha",
                longitude_J2000: 138.21,
                effect: "Protección familiar",
                filePath: "https://www.izarren.top/talitha",
                magnitude: 6
            },
            {
                name: "Nashira",
                longitude_J2000: 299.41,
                effect: "Peligros superados",
                filePath: "https://www.izarren.top/nashira",
                magnitude: 6
            },
            {
                name: "Kaus Australis",
                longitude_J2000: 275.52,
                effect: "Éxito en objetivos",
                filePath: "https://www.izarren.top/kaus-austral",
                magnitude: 6
            },
            {
                name: "Kaus Media",
                longitude_J2000: 274.21,
                effect: "Intuición espiritual",
                filePath: "https://www.izarren.top/kaus-media",
                magnitude: 6
            },
            {
                name: "Kaus Borealis",
                longitude_J2000: 272.41,
                effect: "Logros materiales",
                filePath: "https://www.izarren.top/kaus-boreal",
                magnitude: 6
            },
            {
                name: "Lesath",
                longitude_J2000: 264.11,
                effect: "Peligro y advertencia",
                filePath: "https://www.izarren.top/lesath",
                magnitude: 6
            },
            {
                name: "Larawag",
                longitude_J2000: 251.49,
                effect: "Peligro de venenos",
                filePath: "https://www.izarren.top/larawag",
                magnitude: 6
            },
            {
                name: "Ras Alhague",
                longitude_J2000: 263.17,
                effect: "Curación y medicina",
                filePath: "https://www.izarren.top/rasalhague",
                magnitude: 6
            },
            {
                name: "Graffias",
                longitude_J2000: 242.43,
                effect: "Peligro y malevolencia",
                filePath: "https://www.izarren.top/grafias",
                magnitude: 6
            },
            {
                name: "Dschubba",
                longitude_J2000: 240.47,
                effect: "Peligro y destrucción",
                filePath: "https://www.izarren.top/dschubba",
                magnitude: 6
            },
            {
                name: "Wasat",
                longitude_J2000: 106.17,
                effect: "Violencia, malevolencia",
                filePath: "https://www.izarren.top/wasat",
                magnitude: 6
            },

function calculatePrecession(date) {
    const currentDate = new Date(date);
    const year = currentDate.getFullYear() + (currentDate.getMonth() + 1) / 12;
    const yearsSinceJ2000 = year - 2000.0;
    const precessionRate = 50.2908 / 3600.0;
    return precessionRate * yearsSinceJ2000;
}

// ACTUALIZADO: Función modificada para usar el ayanamsa del servidor
function getCurrentStarPosition(star, date, useSidereal = false, serverAyanamsa = null) {
    // Primero calculamos la posición con precesión (posición tropical)
    const precession = calculatePrecession(date);
    const tropicalPosition = (star.longitude_J2000 + precession) % 360;
    
    if (useSidereal) {
        // Para zodiaco sideral, usar el ayanamsa proporcionado por el servidor si está disponible
        // o calcular uno aproximado si no lo está
        let ayanamsa;
        if (serverAyanamsa !== null) {
            ayanamsa = serverAyanamsa;
        } else {
            // Fecha J2000.0 estándar: 1 enero 2000, 12:00 UTC
            const j2000 = new Date(Date.UTC(2000, 0, 1, 12, 0, 0));
            // Ayanamsa Fagan-Allen en J2000.0 era aproximadamente 24°
            const ayanamsaJ2000 = 24.0;
            
            // Calcular años desde J2000.0
            const dateObj = new Date(date);
            const yearsSinceJ2000 = (dateObj - j2000) / (365.25 * 24 * 60 * 60 * 1000);
            
            // La precesión avanza aprox. 50.3 segundos de arco por año
            // que es igual a 50.3/3600 = 0.01397 grados por año
            const precessionRate = 0.01397;
            
            // Ayanamsa actual = Ayanamsa en J2000 + la precesión acumulada
            ayanamsa = ayanamsaJ2000 + (precessionRate * yearsSinceJ2000);
        }
        
        // Aplicar el ayanamsa a la posición tropical
        return (tropicalPosition - ayanamsa + 360) % 360;
    } else {
        // Para zodiaco tropical, usamos la posición tropical normal
        return tropicalPosition;
    }
}

function determineHouse(longitude, ascendant) {
    if (ascendant === undefined || ascendant === null) return null;
    let relativeLongitude = longitude - ascendant;
    if (relativeLongitude < 0) relativeLongitude += 360;
    const house = Math.floor(relativeLongitude / 30) + 1;
    return house > 12 ? house - 12 : house;
}

function getPlanetColor(planet, longitude) {
    // Función actualizada para usar colores pastel
    if (planet === 'ASC' || planet === 'MC' || planet === 'DSC' || planet === 'IC' ||
        planet === 'PARTE_FORTUNA' || planet === 'PARTE_ESPIRITU') {
        return PASTEL_COLORS.GRAY;
    }
    
    if (planet === 'JÚPITER') {
        if ((longitude >= 306.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00)) 
            return PASTEL_COLORS.BLUE;
        if (longitude > 150.00 && longitude < 306.00) 
            return PASTEL_COLORS.RED;
        return PASTEL_COLORS.BLUE;
    }

    if (planet === 'SATURNO') {
        if ((longitude >= 330.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00))
            return PASTEL_COLORS.YELLOW;
        if (longitude > 240.00 && longitude <= 252.00) 
            return PASTEL_COLORS.YELLOW;
        if (longitude > 252.00 && longitude <= 330.00) 
            return PASTEL_COLORS.RED;
        if (longitude > 150.00 && longitude <= 240.00) 
            return PASTEL_COLORS.RED;
        return PASTEL_COLORS.YELLOW;
    }

    if (longitude > 150.00 && longitude <= 330.00) {
        switch(planet) {
            case 'SOL': case 'MERCURIO': case 'URANO': return PASTEL_COLORS.GREEN;
            case 'VENUS': case 'LUNA': return PASTEL_COLORS.YELLOW;
            case 'MARTE': case 'PLUTÓN': return PASTEL_COLORS.BLUE;
            case 'NEPTUNO': return PASTEL_COLORS.RED;
            default: return PASTEL_COLORS.GRAY;
        }
    } else {
        switch(planet) {
            case 'SOL': case 'MARTE': case 'PLUTÓN': return PASTEL_COLORS.RED;
            case 'VENUS': return PASTEL_COLORS.GREEN;
            case 'MERCURIO': case 'URANO': return PASTEL_COLORS.YELLOW;
            case 'LUNA': case 'NEPTUNO': return PASTEL_COLORS.BLUE;
            default: return PASTEL_COLORS.GRAY;
        }
    }
}

function calculateAspects(planets) {
    const aspects = [];
    const validPlanets = planets;

    for (let i = 0; i < validPlanets.length; i++) {
        for (let j = i + 1; j < validPlanets.length; j++) {
            const planet1 = validPlanets[i];
            const planet2 = validPlanets[j];
            let diff = Math.abs(planet1.longitude - planet2.longitude);
            if (diff > 180) diff = 360 - diff;
            
            for (const [aspectType, aspect] of Object.entries(ASPECTS)) {
                if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                    aspects.push({
                        planet1: planet1.name,
                        planet2: planet2.name,
                        type: aspectType,
                        angle: diff,
                        color: aspect.color
                    });
                    break;
                }
            }
        }
    }
    return aspects;
}

// Función para calcular aspectos entre dos conjuntos de planetas
function calculateAspectsBetweenSets(planets1, planets2) {
    const aspects = [];
    const traditional_planets = ["SOL", "LUNA", "MERCURIO", "VENUS", "MARTE", "JÚPITER", "SATURNO"];
    
    // Filtrar planetas tradicionales
    const validPlanets1 = planets1.filter(p => traditional_planets.includes(p.name));
    const validPlanets2 = planets2.filter(p => traditional_planets.includes(p.name));
    
    // Aspectos entre planetas diferentes
    for (let i = 0; i < validPlanets1.length; i++) {
        for (let j = 0; j < validPlanets2.length; j++) {
            const planet1 = validPlanets1[i];
            const planet2 = validPlanets2[j];
            
            // Si es el mismo planeta, lo manejamos más abajo
            if (planet1.name === planet2.name) continue;
            
            // Calcular la diferencia angular
            let diff = Math.abs(planet1.longitude - planet2.longitude);
            if (diff > 180) diff = 360 - diff;
            
            // Buscar aspectos
            for (const [aspectType, aspect] of Object.entries(ASPECTS)) {
                if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                    aspects.push({
                        planet1: planet1.name,
                        planet2: planet2.name,
                        type: aspectType,
                        angle: diff,
                        color: aspect.color,
                        isInterChart: true
                    });
                    break;
                }
            }
        }
    }
    
    // Aspectos entre el mismo planeta en natal y tránsito
    for (const natalPlanet of validPlanets1) {
        const transitPlanet = validPlanets2.find(p => p.name === natalPlanet.name);
        if (transitPlanet) {
            let diff = Math.abs(natalPlanet.longitude - transitPlanet.longitude);
            if (diff > 180) diff = 360 - diff;
            
            for (const [aspectType, aspect] of Object.entries(ASPECTS)) {
                if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                    aspects.push({
                        planet1: natalPlanet.name,
                        planet2: transitPlanet.name,
                        type: aspectType,
                        angle: diff,
                        color: aspect.color,
                        isInterChart: true,
                        isSamePlanet: true // Marca que es el mismo planeta
                    });
                    break;
                }
            }
        }
    }
    
    return aspects;
}

// ACTUALIZADO: Modificado para usar el ayanamsa del servidor
function getActiveStars(planets, date, useSidereal = false, serverAyanamsa = null) {
    return FIXED_STARS.filter(star => {
        const currentLongitude = getCurrentStarPosition(
            star, 
            date, 
            useSidereal, 
            serverAyanamsa
        );
        return planets.some(planet => {
            const diff = Math.abs(currentLongitude - planet.longitude);
            const adjustedDiff = Math.min(diff, 360 - diff);
            const orb = star.magnitude >= 12 ? 2.40 : 1.20;
            return adjustedDiff <= orb;
        });
    });
}

// ACTUALIZADO: Modificado para usar el ayanamsa del servidor
function findConjunctPlanets(star, planets, date, useSidereal = false, serverAyanamsa = null) {
    const currentLongitude = getCurrentStarPosition(
        star, 
        date, 
        useSidereal, 
        serverAyanamsa
    );
    const orb = star.magnitude >= 12 ? 2.40 : 1.20;
    return planets.filter(planet => {
        const diff = Math.abs(currentLongitude - planet.longitude);
        const adjustedDiff = Math.min(diff, 360 - diff);
        return adjustedDiff <= orb;
    }).map(planet => ({
        name: planet.name,
        diff: Math.min(
            Math.abs(currentLongitude - planet.longitude),
            360 - Math.abs(currentLongitude - planet.longitude)
        ).toFixed(2)
    }));
}

function createArcPath(startAngle, endAngle) {
    const start = ((startAngle - 90) * Math.PI) / 180;
    const end = ((endAngle - 90) * Math.PI) / 180;
    
    const x1 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(start);
    const y1 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(start);
    const x2 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(end);
    const y2 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(end);
    
    const x1Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(start);
    const y1Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(start);
    const x2Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(end);
    const y2Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(end);
    
    const largeArcFlag = end - start <= Math.PI ? "0" : "1";
    
    return `M ${x1} ${y1} A ${DIMENSIONS.radius} ${DIMENSIONS.radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x2Inner} ${y2Inner} A ${DIMENSIONS.innerRadius} ${DIMENSIONS.innerRadius} 0 ${largeArcFlag} 0 ${x1Inner} ${y1Inner} Z`;
}

// Función para crear arcos de los términos astrológicos
function createTermArcPath(startAngle, endAngle, innerRadius, outerRadius) {
    const start = ((startAngle - 90) * Math.PI) / 180;
    const end = ((endAngle - 90) * Math.PI) / 180;
    
    const x1 = DIMENSIONS.centerX + outerRadius * Math.cos(start);
    const y1 = DIMENSIONS.centerY + outerRadius * Math.sin(start);
    const x2 = DIMENSIONS.centerX + outerRadius * Math.cos(end);
    const y2 = DIMENSIONS.centerY + outerRadius * Math.sin(end);
    
    const x1Inner = DIMENSIONS.centerX + innerRadius * Math.cos(start);
    const y1Inner = DIMENSIONS.centerY + innerRadius * Math.sin(start);
    const x2Inner = DIMENSIONS.centerX + innerRadius * Math.cos(end);
    const y2Inner = DIMENSIONS.centerY + innerRadius * Math.sin(end);
    
    const largeArcFlag = end - start <= Math.PI ? "0" : "1";
    
    return `M ${x1} ${y1} A ${outerRadius} ${outerRadius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x2Inner} ${y2Inner} A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x1Inner} ${y1Inner} Z`;
}

function App() {
    console.log("Componente App inicializado");
    // Estados
    const [cities, setCities] = React.useState([]);
    const [cityInput, setCityInput] = React.useState('');
    const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
    const [time, setTime] = React.useState(new Date().toTimeString().slice(0,5));
    const [planets, setPlanets] = React.useState([]);
    const [aspects, setAspects] = React.useState([]);
    const [error, setError] = React.useState('');
    const [selectedAspect, setSelectedAspect] = React.useState(null);
    const [selectedPlanet, setSelectedPlanet] = React.useState(null);
    const [activeStars, setActiveStars] = React.useState([]);
    const [transitActiveStars, setTransitActiveStars] = React.useState([]);
    const [interpretations, setInterpretations] = React.useState({
        planets_in_signs: [],
        planets_in_houses: [],
        aspects: [],
        house_rulers: []
    });
    const [transitInterpretations, setTransitInterpretations] = React.useState({
        planets_in_signs: [],
        planets_in_houses: [],
        aspects: [],
        house_rulers: []
    });
    
    // Estados para tránsitos y zodiaco sideral
    const [transitCities, setTransitCities] = React.useState([]);
    const [transitCityInput, setTransitCityInput] = React.useState('');
    const [transitDate, setTransitDate] = React.useState(new Date().toISOString().split('T')[0]);
    const [transitTime, setTransitTime] = React.useState(new Date().toTimeString().slice(0,5));
    const [transitPlanets, setTransitPlanets] = React.useState([]);
    const [interChartAspects, setInterChartAspects] = React.useState([]);
    const [showTransits, setShowTransits] = React.useState(false);
    const [useSiderealZodiac, setUseSiderealZodiac] = React.useState(false);
    const [loading, setLoading] = React.useState(false);
    const [isDry, setIsDry] = React.useState(null);
    
    // ACTUALIZADO: Nuevo estado para el ayanamsa del servidor
    const [serverAyanamsa, setServerAyanamsa] = React.useState(null);
    
    // Estado para controlar la visibilidad de pestañas en interpretaciones
    const [activeTab, setActiveTab] = React.useState('natal');
    
    // Nuevo estado para términos astrológicos
    const [showTerms, setShowTerms] = React.useState(false);
    const [termInfo, setTermInfo] = React.useState(null);

    // ACTUALIZADO: Uso del ayanamsa en el efecto de estrellas natales
    React.useEffect(() => {
        if (planets.length > 0) {
            const stars = getActiveStars(planets, date, useSiderealZodiac, serverAyanamsa);
            setActiveStars(stars);
            console.log("Estrellas fijas en carta natal:", stars.length);
        }
    }, [planets, date, useSiderealZodiac, serverAyanamsa]);

    // ACTUALIZADO: Uso del ayanamsa en el efecto de estrellas en tránsito
    React.useEffect(() => {
        if (transitPlanets.length > 0 && showTransits) {
            const stars = getActiveStars(transitPlanets, transitDate, useSiderealZodiac, serverAyanamsa);
            setTransitActiveStars(stars);
            console.log("Estrellas fijas en tránsitos:", stars.length);
        } else {
            setTransitActiveStars([]);
        }
    }, [transitPlanets, transitDate, showTransits, useSiderealZodiac, serverAyanamsa]);

    // Función para descargar la rueda como imagen PNG
    const handleDownloadImage = () => {
        // Mostrar indicador de carga
        setLoading(true);
        
        // Seleccionar el contenedor de la rueda
        const wheelContainer = document.querySelector('.wheel-container');
        
        if (!wheelContainer) {
            setError("No se pudo encontrar la rueda astrológica");
            setLoading(false);
            return;
        }
        
        // Configurar opciones para html2canvas
        const options = {
            scale: 2, // Mayor escala para mejor calidad
            backgroundColor: '#FFFFFF',
            logging: false
        };
        
        // Convertir la rueda a canvas
        html2canvas(wheelContainer, options).then(canvas => {
            // Crear enlace para descargar
            const link = document.createElement('a');
            link.download = `carta-astral-${date.replace(/-/g, '')}.png`;
            
            // Convertir canvas a blob
            canvas.toBlob(function(blob) {
                link.href = URL.createObjectURL(blob);
                link.click();
                
                // Limpiar
                URL.revokeObjectURL(link.href);
                setLoading(false);
            }, 'image/png');
        }).catch(err => {
            console.error("Error generando imagen:", err);
            setError("Error al generar la imagen");
            setLoading(false);
        });
    };

// Función modificada para generar y descargar PDF, con validación para tránsitos
const handleDownloadPDF = () => {
    // Comprobar si los tránsitos están activos
    if (showTransits) {
        // No permitir descargar PDF con tránsitos activos
        setError("Para descargar el PDF, desactiva primero los tránsitos");
        return;
    }
    
    // Mostrar indicador de carga
    setLoading(true);
    
    // Importar jsPDF desde el objeto global
    const { jsPDF } = window.jspdf;
    
    // Seleccionar elementos para incluir en el PDF
    const wheelContainer = document.querySelector('.wheel-container');
    const infoPanel = document.querySelector('.info-panel');
    
    if (!wheelContainer || !infoPanel) {
        setError("No se pudo encontrar todos los elementos necesarios");
        setLoading(false);
        return;
    }
    
    // Crear un nuevo documento PDF
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });
    
    // Configurar título
    doc.setFontSize(20);
    doc.text("Carta Astral", 105, 20, { align: 'center' });
    
    // Añadir fecha
    doc.setFontSize(12);
    doc.text(`Generado el ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
    
    // Capturar la rueda como imagen (solo natal)
    html2canvas(wheelContainer, { scale: 2, backgroundColor: '#FFFFFF' }).then(wheelCanvas => {
        // Añadir la imagen de la rueda al PDF
        const wheelImg = wheelCanvas.toDataURL('image/png');
        const imgWidth = 180; // Ancho de la imagen en mm
        const imgHeight = (wheelCanvas.height * imgWidth) / wheelCanvas.width;
        doc.addImage(wheelImg, 'PNG', 15, 40, imgWidth, imgHeight);
        
        let yPos = 40 + imgHeight + 10; // Posición Y después de la imagen
        
        // Añadir información del panel de datos
        doc.setFontSize(14);
        doc.text("Información de la Carta", 105, yPos, { align: 'center' });
        yPos += 8;
        
        // Extraer texto del panel de información
        doc.setFontSize(10);
        const infoPanelText = infoPanel.innerText.split('\n');
        infoPanelText.forEach(line => {
            doc.text(line, 15, yPos);
            yPos += 6;
        });
        
        // *** PLANETAS Y ESTRELLAS FIJAS (PÁGINA 2) ***
        doc.addPage();
        yPos = 20;
        
        // Título de la página
        doc.setFontSize(16);
        doc.text("Posiciones Planetarias", 105, yPos, { align: 'center' });
        yPos += 15;
        
        // Columnas para planetas
        doc.setFontSize(14);
        doc.text("Planetas en Signos", 52, yPos, { align: 'center' });
        doc.text("Planetas en Casas", 158, yPos, { align: 'center' });
        yPos += 10;
        
        // Preparar coordenadas para las columnas
        const leftColX = 15;
        const rightColX = 105;
        const pageWidth = 210 - 30; // Ancho total de página menos márgenes
        const colWidth = pageWidth / 2 - 5; // Medio ancho menos un pequeño margen entre columnas
        
        // Variables para la posición vertical de cada columna
        let leftYPos = yPos;
        let rightYPos = yPos;
        
        // Obtener todos los planetas (incluidos los exteriores para las casas)
        const allPlanetaryCelestials = planets.filter(p => 
            p.name !== "ASC" && p.name !== "MC" && p.name !== "DSC" && 
            p.name !== "IC" && p.name !== "PARTE_FORTUNA" && p.name !== "PARTE_ESPIRITU"
        );
        
        // Columna izquierda: Planetas en signos
        doc.setFontSize(10);
        allPlanetaryCelestials.forEach(planet => {
            let retroSymbol = '';
            if (planet.motion_status === 'retrograde') {
                retroSymbol = ' ℞';
            } else if (planet.motion_status === 'stationary_retrograde') {
                retroSymbol = ' Sr';
            } else if (planet.motion_status === 'stationary_direct') {
                retroSymbol = ' Sd';
            }
            
            const planetText = `${planet.name}${retroSymbol}: ${planet.sign} ${convertirGradosZodiacales(planet.longitude, planet.sign)}`;
            doc.text(planetText, leftColX, leftYPos);
            leftYPos += 6;
        });
        
        // Columna derecha: Planetas en casas
        allPlanetaryCelestials.forEach(planet => {
            if (planet.house !== undefined) {
                const planetText = `${planet.name} en Casa ${planet.house}`;
                doc.text(planetText, rightColX, rightYPos);
                rightYPos += 6;
            }
        });
        
        // *** ESTRELLAS FIJAS EN DOS COLUMNAS EQUILIBRADAS ***
        // Determinar el punto Y más bajo entre las dos columnas para empezar
        const maxY = Math.max(leftYPos, rightYPos) + 15;
        
        // Título para estrellas fijas
        doc.setFontSize(14);
        doc.text("Estrellas Fijas", 105, maxY, { align: 'center' });
        let starBaseY = maxY + 8;
        
        // Ordenar estrellas: primero las de primera magnitud, luego las demás
        const sortedStars = [...activeStars].sort((a, b) => 
            (b.magnitude || 0) - (a.magnitude || 0)
        );
        
        // Dividir las estrellas en dos columnas equilibradas
        const halfIndex = Math.ceil(sortedStars.length / 2);
        const leftStars = sortedStars.slice(0, halfIndex);
        const rightStars = sortedStars.slice(halfIndex);
        
        // Columna izquierda de estrellas
        doc.setFontSize(10);
        let leftStarY = starBaseY;
        
        leftStars.forEach(star => {
            const conjunctPlanets = findConjunctPlanets(star, planets, date, useSiderealZodiac, serverAyanamsa);
            
            // Destacar las estrellas de primera magnitud
            if (star.magnitude >= 12) {
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
            } else {
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
            }
            
            // Quitar los grados de la estrella
            const starText = `${star.name}`;
            doc.text(starText, leftColX, leftStarY);
            leftStarY += 5;
            
            // Restaurar fuente normal para el texto de conjunción
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            if (conjunctPlanets.length > 0) {
                // Usar nombres de planetas completos sin la palabra "Conjunción con:"
                const planetNames = conjunctPlanets.map(p => 
                    `${p.name} (${p.diff}°)`
                ).join(', ');
                
                // Dividir el texto en múltiples líneas si es necesario
                const planetLines = doc.splitTextToSize(`   ${planetNames}`, colWidth);
                
                planetLines.forEach(line => {
                    doc.text(line, leftColX, leftStarY);
                    leftStarY += 5;
                });
            }
            
            leftStarY += 2; // Espacio entre estrellas
        });
        
        // Columna derecha de estrellas
        let rightStarY = starBaseY;
        
        rightStars.forEach(star => {
            const conjunctPlanets = findConjunctPlanets(star, planets, date, useSiderealZodiac, serverAyanamsa);
            
            // Destacar las estrellas de primera magnitud
            if (star.magnitude >= 12) {
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
            } else {
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
            }
            
            // Quitar los grados de la estrella
            const starText = `${star.name}`;
            doc.text(starText, rightColX, rightStarY);
            rightStarY += 5;
            
            // Restaurar fuente normal para el texto de conjunción
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            if (conjunctPlanets.length > 0) {
                // Usar nombres de planetas completos sin la palabra "Conjunción con:"
                const planetNames = conjunctPlanets.map(p => 
                    `${p.name} (${p.diff}°)`
                ).join(', ');
                
                // Dividir el texto en múltiples líneas si es necesario
                const planetLines = doc.splitTextToSize(`   ${planetNames}`, colWidth);
                
                planetLines.forEach(line => {
                    doc.text(line, rightColX, rightStarY);
                    rightStarY += 5;
                });
            }
            
            rightStarY += 2; // Espacio entre estrellas
        });
        
        // *** INTERPRETACIONES (PÁGINA 3) ***
        if (interpretations && (interpretations.planets_in_signs.length > 0 || interpretations.planets_in_houses.length > 0)) {
            doc.addPage();
            yPos = 20;
            
            // Título de interpretaciones
            doc.setFontSize(16);
            doc.text("Interpretaciones", 105, yPos, { align: 'center' });
            yPos += 15;
            
            // Interpretaciones de planetas en signos (usar todo el ancho)
            doc.setFontSize(14);
            doc.text("Planetas en Signos", 105, yPos, { align: 'center' });
            yPos += 10;
            
            // Procesar interpretaciones de signos
            doc.setFontSize(10);
            interpretations.planets_in_signs.forEach((interp, index) => {
                // Verificar si hay espacio en la página
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                    doc.setFontSize(14);
                    doc.text("Planetas en Signos (continuación)", 105, yPos, { align: 'center' });
                    yPos += 10;
                    doc.setFontSize(10);
                }
                
                // Título de la interpretación
                doc.setFontSize(12);
                doc.text(`${interp.planet} en ${interp.sign}`, 15, yPos);
                yPos += 6;
                
                // Contenido de la interpretación
                doc.setFontSize(10);
                
                // Plano físico
                if (interp.interpretation.physical) {
                    const physicalText = `Plano Físico: ${interp.interpretation.physical}`;
                    const physicalLines = doc.splitTextToSize(physicalText, 180); // Usar todo el ancho disponible
                    
                    physicalLines.forEach(line => {
                        doc.text(line, 15, yPos);
                        yPos += 5;
                        
                        // Verificar si necesitamos nueva página
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                            doc.setFontSize(10);
                        }
                    });
                    
                    yPos += 2;
                }
                
                // Plano astral
                if (interp.interpretation.astral) {
                    const astralText = `En el plano Astral: ${interp.interpretation.astral}`;
                    const astralLines = doc.splitTextToSize(astralText, 180); // Usar todo el ancho disponible
                    
                    astralLines.forEach(line => {
                        doc.text(line, 15, yPos);
                        yPos += 5;
                        
                        // Verificar si necesitamos nueva página
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                            doc.setFontSize(10);
                        }
                    });
                }
                
                yPos += 8; // Espacio entre interpretaciones
            });
            
            // Interpretaciones de planetas en casas
            // Comprobar si tenemos espacio en la página actual o necesitamos una nueva
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
            } else {
                yPos += 10;
            }
            
            doc.setFontSize(14);
            doc.text("Planetas en Casas", 105, yPos, { align: 'center' });
            yPos += 10;
            
            // Procesar interpretaciones de casas
            doc.setFontSize(10);
            interpretations.planets_in_houses.forEach((interp, index) => {
                // Verificar si hay espacio en la página
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                    doc.setFontSize(14);
                    doc.text("Planetas en Casas (continuación)", 105, yPos, { align: 'center' });
                    yPos += 10;
                    doc.setFontSize(10);
                }
                
                // Título de la interpretación
                doc.setFontSize(12);
                doc.text(`${interp.planet} en Casa ${interp.house}`, 15, yPos);
                yPos += 6;
                
                // Contenido de la interpretación
                doc.setFontSize(10);
                const textLines = doc.splitTextToSize(interp.interpretation, 180); // Usar todo el ancho disponible
                
                textLines.forEach(line => {
                    doc.text(line, 15, yPos);
                    yPos += 5;
                    
                    // Verificar si necesitamos nueva página
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                        doc.setFontSize(10);
                    }
                });
                
                yPos += 8; // Espacio entre interpretaciones
            });
        }
        
        // Guardar el PDF
        doc.save(`carta-astral-completa-${date.replace(/-/g, '')}.pdf`);
        
        // Desactivar indicador de carga
        setLoading(false);
    }).catch(err => {
        console.error("Error generando PDF:", err);
        setError("Error al generar el PDF");
        setLoading(false);
    });
};

    // Función para determinar el término astrológico de un planeta
    const getPlanetTerm = (longitude, sign) => {
        // Si no hay términos definidos para este signo
        if (!TERMS[sign]) return null;
        
        // Encontrar la posición relativa dentro del signo
        const signInfo = SIGNS.find(s => s.name === sign);
        if (!signInfo) return null;
        
        // Calcular grados dentro del signo (0-30 o la longitud correspondiente)
        let degreesInSign;
        
        // Caso especial para Aries que cruza 0°
        if (sign === 'ARIES') {
            if (longitude >= 354) {
                degreesInSign = longitude - 354;
            } else {
                degreesInSign = longitude + 6; // 360-354 = 6
            }
        } else {
            // Convertir longitud absoluta a grados dentro del signo
            const signStart = signInfo.start;
            degreesInSign = ((longitude - signStart) * 30) / signInfo.length;
        }
        
        // Encontrar el término correspondiente
        const term = TERMS[sign].find(t => 
            degreesInSign >= t.start && degreesInSign < t.end
        );
        
        if (!term) return null;
        
        // Extraer la parte base del nombre del planeta (antes del guión bajo)
        const basePlanetName = term.planet.split('_')[0];
        
        return {
            planet: basePlanetName,
            symbol: TERMS.symbols[term.planet],
            color: TERMS.colors[term.planet],
            degrees: `${term.start}°-${term.end}°`
        };
    };
    
    // Manejador para ocultar información de término
    const handlePlanetLeave = () => {
        setTermInfo(null);
    };

    // Renderiza el anillo de términos
    const renderTermsLayer = () => {
        if (!showTerms) return null;
        
        const segments = [];
        
        SIGNS.forEach(sign => {
            // Obtener los términos correspondientes para este signo
            const signTerms = TERMS[sign.name];
            
            // Si no hay términos definidos para este signo, sáltalo
            if (!signTerms) return;
            
            // Para cada término en este signo
            signTerms.forEach((term, index) => {
                // Calcular los ángulos de inicio y fin del término dentro del signo
                const termStartAngle = sign.start + (term.start / 30) * sign.length;
                const termEndAngle = sign.start + (term.end / 30) * sign.length;
                
                // Crear arco para el término
                const termArc = createTermArcPath(
                    termStartAngle, 
                    termEndAngle, 
                    DIMENSIONS.termsInnerRadius, 
                    DIMENSIONS.termsOuterRadius
                );
                
                // Obtener el color y símbolo específico para este término
                const planetColor = TERMS.colors[term.planet];
                const planetSymbol = TERMS.symbols[term.planet];
                
                // Calcular posición para el símbolo del planeta regente
                const midAngle = ((termStartAngle + termEndAngle) / 2 - 90) * Math.PI / 180;
                const symbolX = DIMENSIONS.centerX + DIMENSIONS.termsSymbolRadius * Math.cos(midAngle);
                const symbolY = DIMENSIONS.centerY + DIMENSIONS.termsSymbolRadius * Math.sin(midAngle);
                
                // Añadir segmento y símbolo
                segments.push(
                    <g key={`term-${sign.name}-${index}`}>
                        <path
                            d={termArc}
                            fill={planetColor}
                            stroke="#333"
                            strokeWidth="0.5"
                            className="term-path"
                        />
                        <text
                            x={symbolX}
                            y={symbolY}
                            textAnchor="middle"
                            alignmentBaseline="middle"
                            fontSize="10"
                            fontWeight="bold"
                            fill="#333"
                            className="term-symbol"
                        />
                            {planetSymbol}
                        </text>
                    </g>
                );
            });
        });
        
        return segments;
    };

    
    // Renderiza la leyenda de términos
    const renderTermsLegend = () => {
        if (!showTerms) return null;
        
        // Lista de planetas para la leyenda
        const legendItems = [
            { planet: "JUPITER", variants: ["JUPITER_GREEN", "JUPITER_YELLOW"], name: "JÚPITER" },
            { planet: "VENUS", variants: ["VENUS_YELLOW", "VENUS_GREEN"], name: "VENUS" },
            { planet: "MERCURIO", variants: ["MERCURIO_BLUE", "MERCURIO_CYAN"], name: "MERCURIO" },
            { planet: "MARTE", variants: ["MARTE_RED", "MARTE_YELLOW"], name: "MARTE" }
        ];
        
        return (
            <div className="terms-legend">
                <div style={{width: '100%', textAlign: 'center', marginBottom: '8px', fontWeight: 'bold'}}>
                    Términos Astrológicos
                </div>
                
                {legendItems.map(item => (
                    <div key={`legend-${item.planet}`} className="legend-item">
                        {item.variants.map((variant, idx) => (
                            <div key={variant} style={{display: 'flex', alignItems: 'center', marginRight: '8px'}}>
                                <div className="legend-color" style={{backgroundColor: TERMS.colors[variant]}}></div>
                                <span>{idx === 0 ? item.name : ''} {TERMS.symbols[variant]}</span>
                            </div>
                        ))}
                    </div>
                ))}
            </div>
        );
    };

    // Manejadores de eventos
    const handleCalculate = () => {
        console.log("Calculando para ciudad:", cityInput);
        
        if (!cityInput || !date || !time) {
            setError("Debes ingresar ciudad, fecha y hora.");
            return;
        }

        setLoading(true);
        setError("");
        
        console.log("Datos para cálculo:", { 
            city: cityInput, 
            date, 
            time, 
            useSidereal: useSiderealZodiac 
        });
        
        const apiUrl = `/calculate`;

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                city: cityInput,
                date: date,
                time: time,
                useSidereal: useSiderealZodiac
            })
        })
        .then(response => {
            console.log("Respuesta status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("Datos recibidos:", data);
            if (data.error) throw new Error(data.error);

            document.getElementById("location").innerHTML = `<b>Ciudad:</b> ${data.city}`;
            document.getElementById("coordinates").innerHTML = `<b>Coordenadas:</b> Lat ${data.coordinates.latitude}, Lon ${data.coordinates.longitude}`;
            
            // Mostrar información de zona horaria
            if (data.timezone) {
                const dstInfo = data.timezone.is_dst ? "Horario de verano activo" : "Horario estándar";
                const abbr = data.timezone.is_dst ? data.timezone.abbreviation_DST : data.timezone.abbreviation_STD;
                const hemisferio = data.timezone.hemisphere === "norte" ? "Hemisferio Norte" : "Hemisferio Sur";
                document.getElementById("timezone").innerHTML = `<b>Zona horaria:</b> ${data.timezone.name} (${abbr}) - ${dstInfo} - ${hemisferio}`;
                document.getElementById("time-conversion").innerHTML = `<b>Hora local:</b> ${data.local_time} → <b>UTC:</b> ${data.utc_time}`;
            } else if (data.error_timezone) {
                document.getElementById("timezone").innerHTML = `<b>Advertencia:</b> ${data.error_timezone}`;
            }

            // ACTUALIZADO: Mostrar ayanamsa si está en modo sideral
            if (useSiderealZodiac && data.ayanamsa) {
                document.getElementById("zodiac-system").innerHTML = `<b>Sistema zodiacal:</b> Sideral (Fagan-Allen) - Ayanamsa: ${data.ayanamsa.toFixed(4)}°`;
                // Guardar el ayanamsa para usarlo en los cálculos de estrellas fijas
                setServerAyanamsa(data.ayanamsa);
            } else {
                document.getElementById("zodiac-system").innerHTML = `<b>Sistema zodiacal:</b> ${useSiderealZodiac ? 'Sideral (Fagan-Allen)' : 'Tropical'}`;
            }

            setPlanets(data.positions);
            setAspects(calculateAspects(data.positions));
            setInterpretations(data.interpretations);
            setIsDry(data.isDry);
            
            // Si los tránsitos están habilitados, calcularlos también
            if (showTransits && transitCityInput && transitDate && transitTime) {
                handleCalculateTransits();
            } else {
                setLoading(false);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            setError(`Error en la consulta: ${err.message}`);
            setLoading(false);
        });
    };
    
    const handleCalculateTransits = () => {
        if (!transitCityInput || !transitDate || !transitTime) {
            setError("Debes ingresar ciudad, fecha y hora para los tránsitos.");
            return;
        }
        
        console.log("Datos para tránsitos:", { 
            city: transitCityInput, 
            date: transitDate, 
            time: transitTime,
            useSidereal: useSiderealZodiac 
        });
        
        fetch('/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                city: transitCityInput,
                date: transitDate,
                time: transitTime,
                useSidereal: useSiderealZodiac
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Datos de tránsitos recibidos:", data);
            if (data.error) throw new Error(data.error);
            
            // ACTUALIZADO: Guardar el ayanamsa del servidor si está disponible y no se ha guardado aún
            if (useSiderealZodiac && data.ayanamsa && !serverAyanamsa) {
                setServerAyanamsa(data.ayanamsa);
            }
            
            setTransitPlanets(data.positions);
            setTransitInterpretations(data.interpretations);
            
            // Calcular aspectos entre cartas (natal y tránsitos)
            const interAspects = calculateAspectsBetweenSets(planets, data.positions);
            setInterChartAspects(interAspects);
            
            setLoading(false);
        })
        .catch(err => {
            console.error('Error en tránsitos:', err);
            setError(`Error calculando tránsitos: ${err.message}`);
            setLoading(false);
        });
    };

    const handlePlanetClick = (planetName) => {
        setSelectedPlanet(selectedPlanet === planetName ? null : planetName);
        setSelectedAspect(null);
    };

    // CORRECCIÓN: Modificada la función handleAspectClick para seleccionar correctamente los aspectos
    const handleAspectClick = (aspect) => {
        setSelectedAspect(selectedAspect === aspect ? null : aspect);
        setSelectedPlanet(null);  // Asegurarse de que ningún planeta esté seleccionado directamente
    };

    const handleStarClick = (star) => {
        if (star.filePath) {
            window.open(star.filePath, "_blank");
        }
    };

    const handleCitySearch = (e, isTransit = false) => {
        const searchText = e.target.value;
        if (isTransit) {
            setTransitCityInput(searchText);
        } else {
            setCityInput(searchText);
        }
        
        if (searchText.length >= 3) {
            console.log(`Buscando ciudades ${isTransit ? '(tránsito)' : ''}:`, searchText);
            fetch(`/cities?ciudad=${encodeURIComponent(searchText)}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Respuesta de ciudades:", data);
                    if (data.ciudades && Array.isArray(data.ciudades)) {
                        if (isTransit) {
                            setTransitCities(data.ciudades.map(ciudad => ({ value: ciudad, label: ciudad })));
                        } else {
                            setCities(data.ciudades.map(ciudad => ({ value: ciudad, label: ciudad })));
                        }
                    } else {
                        console.log("Formato de respuesta inesperado:", data);
                    }
                })
                .catch(err => {
                    console.error("Error buscando ciudades:", err);
                    setError("Error al buscar ciudades, intenta de nuevo");
                });
        }
    };
    
    const toggleTransits = () => {
        setShowTransits(!showTransits);
        // Resetear a pestaña natal cuando se activan o desactivan tránsitos
        setActiveTab('natal');
    };
    
    const toggleSiderealZodiac = () => {
        setUseSiderealZodiac(!useSiderealZodiac);
    };

    // Obtener planetas tradicionales para mostrar
    const traditionalPlanets = ["SOL", "LUNA", "MERCURIO", "VENUS", "MARTE", "JÚPITER", "SATURNO"];
    
    // Filtrar aspectos relevantes (conjunción, oposición, trígono, cuadratura, sextil, quincuncio)
    const relevantAspects = aspects.filter(aspect => 
        ["CONJUNCTION", "OPPOSITION", "TRINE", "SQUARE", "SEXTILE", "QUINCUNX"].includes(aspect.type)
    );
    
    // Filtrar aspectos relevantes entre tránsitos y carta natal
    const relevantInterChartAspects = interChartAspects.filter(aspect => 
        ["CONJUNCTION", "OPPOSITION", "TRINE", "SQUARE", "SEXTILE", "QUINCUNX"].includes(aspect.type)
    );

    // Checar si un planeta de tránsito está seleccionado
    const isTransitPlanetSelected = selectedPlanet && selectedPlanet.includes('_transit');
    const transitPlanetName = isTransitPlanetSelected ? selectedPlanet.replace('_transit', '') : null;
    
    // Determinar qué planetas están involucrados en el aspecto seleccionado
    const planetsInSelectedAspect = selectedAspect 
        ? [selectedAspect.planet1, selectedAspect.planet2] 
        : [];

    return (
        <div>
            {loading && (
                <div className="loading">
                    <div className="loading-spinner"></div>
                </div>
            )}
            
            {/* Formulario moderno */}
            <div className="modern-form">
                <div className="form-row">
                    <div className="form-group">
                        <label>Ciudad de Nacimiento</label>
                        <input 
                            type="text" 
                            className="form-control"
                            placeholder="Ej: Madrid, España" 
                            value={cityInput}
                            onChange={e => handleCitySearch(e, false)}
                            list="ciudades-list"
                        />
                        <datalist id="ciudades-list">
                            {cities.map((city, index) => (
                                <option key={index} value={city.value}>{city.label}</option>
                            ))}
                        </datalist>
                    </div>
                    
                    <div className="form-group">
                        <label>Fecha de Nacimiento</label>
                        <input 
                            type="date" 
                            className="form-control"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                        />
                    </div>
                    
                    <div className="form-group">
                        <label>Hora de Nacimiento</label>
                        <input 
                            type="time" 
                            className="form-control"
                            step="60"
                            value={time}
                            onChange={(e) => setTime(e.target.value)}
                        />
                    </div>
                </div>
                
                <div className="toggle-options">
                    <div className="toggle-switch">
                        <input 
                            type="checkbox" 
                            id="showTransits" 
                            checked={showTransits}
                            onChange={toggleTransits}
                        />
                        <label htmlFor="showTransits"></label>
                        <span className="toggle-label">Mostrar Tránsitos</span>
                    </div>
                    
                    <div className="toggle-switch">
                        <input 
                            type="checkbox" 
                            id="useSiderealZodiac" 
                            checked={useSiderealZodiac}
                            onChange={toggleSiderealZodiac}
                        />
                        <label htmlFor="useSiderealZodiac"></label>
                        <span className="toggle-label">Usar Zodiaco Sideral</span>
                    </div>
                    
                    <div className="toggle-switch">
                        <input 
                            type="checkbox" 
                            id="showTerms" 
                            checked={showTerms}
                            onChange={() => setShowTerms(!showTerms)}
                        />
                        <label htmlFor="showTerms"></label>
                        <span className="toggle-label">Mostrar Términos</span>
                    </div>
                </div>
                
                {showTransits && (
                    <div className="form-row">
                        <div className="form-group">
                            <label>Ciudad de Tránsito</label>
                            <input 
                                type="text" 
                                className="form-control"
                                placeholder="Ej: Madrid, España" 
                                value={transitCityInput}
                                onChange={e => handleCitySearch(e, true)}
                                list="transit-ciudades-list"
                            />
                            <datalist id="transit-ciudades-list">
                                {transitCities.map((city, index) => (
                                    <option key={index} value={city.value}>{city.label}</option>
                                ))}
                            </datalist>
                        </div>
                        
                        <div className="form-group">
                            <label>Fecha de Tránsito</label>
                            <input 
                                type="date" 
                                className="form-control"
                                value={transitDate}
                                onChange={(e) => setTransitDate(e.target.value)}
                            />
                        </div>
                        
                        <div className="form-group">
                            <label>Hora de Tránsito</label>
                            <input 
                                type="time" 
                                className="form-control"
                                step="60"
                                value={transitTime}
                                onChange={(e) => setTransitTime(e.target.value)}
                            />
                        </div>
                    </div>
                )}
                
                <button className="btn-primary" onClick={handleCalculate}>
                    Calcular Carta Astral
                </button>
            </div>

            <div className="info-panel" id="results">
                <div id="location"></div>
                <div id="coordinates"></div>
                <div id="timezone"></div>
                <div id="time-conversion"></div>
                <div id="zodiac-system"></div>
                {isDry !== null && (
                    <div id="birth-type">
                        <b>Tipo de nacimiento:</b> {isDry ? 'Seco (diurno)' : 'Húmedo (nocturno)'}
                    </div>
                )}
            </div>

            {planets.length > 0 && (
                <div className="download-buttons">
                    <button 
                        className="download-btn" 
                        onClick={handleDownloadImage}
                        title="Descargar imagen de la carta astral"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Descargar imagen
                    </button>
                    <div className="btn-tooltip">
                        <button 
                            className="download-btn" 
                            onClick={handleDownloadPDF}
                            disabled={showTransits}
                            title={showTransits ? "Desactiva los tránsitos para descargar PDF" : "Descargar PDF completo de la carta astral"}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            Descargar PDF
                        </button>
                        {showTransits && (
                            <span className="tooltip-text">Desactiva los tránsitos para descargar el PDF completo</span>
                        )}
                    </div>
                </div>
            )}

            {error && <div className="error-message">{error}</div>}

            {planets.length > 0 && (
                <div className="main-container">
                    <div className="left-section">
                        {/* Rueda Astrológica */}
                        <div className="wheel-container">
                            <svg viewBox="0 0 600 600" className="wheel-svg">
                                {/* Círculo exterior */}
                                <circle
                                    cx={DIMENSIONS.centerX}
                                    cy={DIMENSIONS.centerY}
                                    r={DIMENSIONS.radius}
                                    fill="none"
                                    stroke="#333"
                                    strokeWidth="2"
                                />

                                {/* Términos astrológicos (Capa exterior) */}
                                {renderTermsLayer()}

                                {/* Signos zodiacales */}
                                {SIGNS.map(sign => {
                                    const midAngle = ((sign.start + sign.length/2 - 90) * Math.PI) / 180;
                                    const glyphX = DIMENSIONS.centerX + DIMENSIONS.glyphRadius * Math.cos(midAngle);
                                    const glyphY = DIMENSIONS.centerY + DIMENSIONS.glyphRadius * Math.sin(midAngle);
                                    
                                    return (
                                        <g key={sign.name}>
                                            <path
                                                d={createArcPath(sign.start, sign.start + sign.length)}
                                                fill={sign.color}
                                                stroke="#333"
                                                strokeWidth="1"
                                            />
                                            <text
                                                x={glyphX}
                                                y={glyphY}
                                                textAnchor="middle"
                                                alignmentBaseline="middle"
                                                fontSize="20"
                                            >
                                                {sign.symbol}
                                            </text>
                                        </g>
                                    );
                                })}

                                {/* Círculo interior y medio (para tránsitos) */}
                                {showTransits && transitPlanets.length > 0 && (
                                    <circle
                                        cx={DIMENSIONS.centerX}
                                        cy={DIMENSIONS.centerY}
                                        r={DIMENSIONS.middleRadius}
                                        fill="none"
                                        stroke="#333"
                                        strokeWidth="1"
                                        strokeDasharray="3,3"
                                    />
                                )}
                                
                                <circle
                                    cx={DIMENSIONS.centerX}
                                    cy={DIMENSIONS.centerY}
                                    r={DIMENSIONS.innerRadius}
                                    fill="white"
                                    stroke="#333"
                                    strokeWidth="1"
                                />

                                {/* Aspectos entre planetas en carta natal - mostrar TODOS los aspectos */}
                                {!showTransits && aspects.map((aspect, index) => {
                                    const planet1 = planets.find(p => p.name === aspect.planet1);
                                    const planet2 = planets.find(p => p.name === aspect.planet2);
                                    
                                    if (!planet1 || !planet2) return null;
                                    
                                    const angle1 = (planet1.longitude - 90) * Math.PI / 180;
                                    const angle2 = (planet2.longitude - 90) * Math.PI / 180;
                                    
                                    const x1 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle1);
                                    const y1 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle1);
                                    const x2 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle2);
                                    const y2 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle2);
                                    
                                    const aspectInfo = `${PLANET_SYMBOLS[aspect.planet1]} ${convertirGradosZodiacales(planet1.longitude, planet1.sign)} ${planet1.sign} ${ASPECTS[aspect.type].name} ${PLANET_SYMBOLS[aspect.planet2]} ${convertirGradosZodiacales(planet2.longitude, planet2.sign)} ${planet2.sign} (${aspect.angle.toFixed(2)}°)`;
                                    
                                    const isHighlighted = selectedAspect === aspect || 
                                        (selectedPlanet && (aspect.planet1 === selectedPlanet || aspect.planet2 === selectedPlanet));
                                    
                                    // Determinar si es un aspecto relevante
                                    const isRelevantAspect = ["CONJUNCTION", "OPPOSITION", "TRINE", "SQUARE", "SEXTILE", "QUINCUNX"].includes(aspect.type);
                                    
                                    return (
                                        <line
                                            key={`aspect-${index}`}
                                            x1={x1}
                                            y1={y1}
                                            x2={x2}
                                            y2={y2}
                                            stroke={aspect.color}
                                            strokeWidth={isHighlighted ? "3" : "1"}
                                            strokeDasharray={aspect.type === 'OPPOSITION' ? "5,5" : (isRelevantAspect ? "none" : "1,1")}
                                            className="aspect-line"
                                            opacity={isRelevantAspect ? 1 : 0.5}
                                            onClick={() => handleAspectClick(aspect)}
                                        >
                                            <title>{aspectInfo}</title>
                                        </line>
                                    );
                                })}
                                
                                {/* Aspectos entre tránsitos y carta natal - mostrar TODOS los aspectos */}
                                {showTransits && transitPlanets.length > 0 && interChartAspects.map((aspect, index) => {
                                    const planet1 = planets.find(p => p.name === aspect.planet1);
                                    const planet2 = transitPlanets.find(p => p.name === aspect.planet2);
                                    
                                    if (!planet1 || !planet2) return null;
                                    
                                    const angle1 = (planet1.longitude - 90) * Math.PI / 180;
                                    const angle2 = (planet2.longitude - 90) * Math.PI / 180;
                                    
                                    const x1 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle1);
                                    const y1 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle1);
                                    const x2 = DIMENSIONS.centerX + DIMENSIONS.middleRadius * Math.cos(angle2);
                                    const y2 = DIMENSIONS.centerY + DIMENSIONS.middleRadius * Math.sin(angle2);
                                    
                                    const aspectInfo = aspect.isSamePlanet
                                        ? `${PLANET_SYMBOLS[aspect.planet1]} (natal) ${ASPECTS[aspect.type].name} ${PLANET_SYMBOLS[aspect.planet2]} (mismo en tránsito) (${aspect.angle.toFixed(2)}°)`
                                        : `${PLANET_SYMBOLS[aspect.planet1]} (natal) ${ASPECTS[aspect.type].name} ${PLANET_SYMBOLS[aspect.planet2]} (tránsito) (${aspect.angle.toFixed(2)}°)`;
                                    
                                    // Destacar aspectos cuando el planeta está seleccionado (en tránsito o natal)
                                    const isHighlighted = 
                                        selectedAspect === aspect || 
                                        (selectedPlanet === aspect.planet1) || 
                                        (transitPlanetName === aspect.planet2);
                                    
                                    // Determinar si es un aspecto relevante
                                    const isRelevantAspect = ["CONJUNCTION", "OPPOSITION", "TRINE", "SQUARE", "SEXTILE", "QUINCUNX"].includes(aspect.type);
                                        
                                    return (
                                        <line
                                            key={`transit-aspect-${index}`}
                                            x1={x1}
                                            y1={y1}
                                            x2={x2}
                                            y2={y2}
                                            stroke={aspect.color}
                                            strokeWidth={isHighlighted ? "3" : "1"}
                                            strokeDasharray="3,3"
                                            className="aspect-line transit-aspect"
                                            opacity={isRelevantAspect ? 1 : 0.5}
                                            onClick={() => handleAspectClick(aspect)}
                                        >
                                            <title>{aspectInfo}</title>
                                        </line>
                                    );
                                })}

                                {/* ACTUALIZADO: Estrellas fijas para carta natal y tránsitos con el ayanamsa del servidor */}
                                {(showTransits ? transitActiveStars : activeStars).map((star, index) => {
                                    const currentLongitude = getCurrentStarPosition(
                                        star, 
                                        showTransits ? transitDate : date, 
                                        useSiderealZodiac, 
                                        serverAyanamsa
                                    );
                                    const angle = (currentLongitude - 90) * Math.PI / 180;
                                    
                                    // Posicionar las estrellas según si es tránsito o carta natal
                                    const starRadius = showTransits ? 
                                        (DIMENSIONS.radius + DIMENSIONS.middleRadius) / 2 :
                                        (DIMENSIONS.radius + DIMENSIONS.innerRadius) / 1.8;
                                        
                                    const x = DIMENSIONS.centerX + starRadius * Math.cos(angle);
                                    const y = DIMENSIONS.centerY + starRadius * Math.sin(angle);
                                    
                                    // ACTUALIZADO: Pasar el ayanamsa a findConjunctPlanets
                                    const conjunctPlanets = findConjunctPlanets(
                                        star, 
                                        showTransits ? transitPlanets : planets, 
                                        showTransits ? transitDate : date,
                                        useSiderealZodiac,
                                        serverAyanamsa
                                    );
                                    
                                    return (
                                        <g 
                                            key={`${showTransits ? 'transit-' : ''}star-${index}`}
                                            onClick={() => handleStarClick(star)}
                                            style={{cursor: 'pointer'}}
                                        >
                                            <text
                                                x={x}
                                                y={y}
                                                textAnchor="middle"
                                                alignmentBaseline="middle"
                                                fill="#FFD700"
                                                stroke="#000"
                                                strokeWidth="0.5"
                                                style={{
                                                    fontSize: star.magnitude === 12 ? "16px" : "12px",
                                                    fontWeight: 'bold'
                                                }}
                                            >
                                                ★
                                            </text>
                                            <title>
                                                {star.name} {showTransits ? "(tránsito)" : ""} - {conjunctPlanets.map(p => 
                                                    `${PLANET_SYMBOLS[p.name]} (${p.diff}°)`
                                                ).join(', ')}
                                            </title>
                                        </g>
                                    )
                                })}
                                
                                {/* Planetas de la carta natal */}
                                {planets
                                  // Filtrar y ordenar los planetas según el orden personalizado
                                  .sort((a, b) => {
                                    // Definir el orden de renderización para que los puntos cardinales estén abajo (primero)
                                    const renderOrder = [
                                      'DSC', 'IC', 'PARTE_FORTUNA', 'PARTE_ESPIRITU', 'ASC', 'MC',
                                      'PLUTÓN', 'NEPTUNO', 'URANO', 'SATURNO', 'JÚPITER', 'MARTE',
                                      'MERCURIO', 'VENUS', 'SOL', 'LUNA'
                                    ];
                                    
                                    // Obtener la posición de cada planeta en el orden definido
                                    const indexA = renderOrder.indexOf(a.name);
                                    const indexB = renderOrder.indexOf(b.name);
                                    
                                    // Si ambos planetas están en la lista, ordenar según la posición
                                    if (indexA !== -1 && indexB !== -1) {
                                      return indexA - indexB;
                                    }
                                    
                                    // Para elementos no incluidos en renderOrder
                                    return 0;
                                  })
                                  .map((planet) => {
                                    const angle = (planet.longitude - 90) * Math.PI / 180;
                                    const x = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle);
                                    const y = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle);
                                    
                                    // CORRECCIÓN: Determinar si el planeta está involucrado en el aspecto seleccionado
                                    const isInSelectedAspect = selectedAspect && 
                                        ((selectedAspect.isInterChart && selectedAspect.planet1 === planet.name) || 
                                        (!selectedAspect.isInterChart && planetsInSelectedAspect.includes(planet.name)));
                                    
                                    // No usamos adjustment porque queremos que los glifos estén dentro de sus círculos
                                    const isSelected = selectedPlanet === planet.name || isInSelectedAspect;
                                    const tooltipText = `${planet.name} ${convertirGradosZodiacales(planet.longitude, planet.sign)} ${planet.sign}`;
                                    
                                    // Determinar el color del planeta con tonos pastel
                                    const planetColor = getPlanetColor(planet.name, planet.longitude);
                                    
                                    // Radio del círculo del planeta, más grande si está seleccionado
                                    const circleRadius = isSelected ? DIMENSIONS.planetCircleRadiusNatal + 2 : DIMENSIONS.planetCircleRadiusNatal;
                                    
                                    // Determinar z-index: puntos cardinales por debajo, planetas por encima
                                    const cardinalPoints = ['DSC', 'IC', 'PARTE_FORTUNA', 'PARTE_ESPIRITU', 'ASC', 'MC'];
                                    const baseZIndex = cardinalPoints.includes(planet.name) ? 1 : 2;
                                    const zIndex = isSelected ? baseZIndex + 10 : baseZIndex;
                                    
                                    return (
                                        <g 
                                            key={planet.name}
                                            onClick={() => handlePlanetClick(planet.name)}
                                            onMouseEnter={() => handlePlanetHover(planet)}
                                            onMouseLeave={handlePlanetLeave}
                                            style={{cursor: 'pointer'}}
                                        >
                                            {/* Círculo más grande para abarcar el glifo */}
                                            <circle
                                                cx={x}
                                                cy={y}
                                                r={circleRadius}
                                                fill={planetColor}
                                                stroke="#000"
                                                strokeWidth={isSelected ? "2" : "1"}
                                                className="natal-planet"
                                                style={{zIndex: zIndex}}
                                            />
                                            
                                            {/* Indicador para planetas retrógrados */}
                                            {planet.motion_status === 'retrograde' && (
                                                <circle
                                                    cx={x}
                                                    cy={y - 8}
                                                    r="3"
                                                    fill="#dc3545"
                                                    stroke="none"
                                                    style={{zIndex: zIndex + 1}}
                                                />
                                            )}
                                            
                                            {/* Indicador para planetas estacionarios */}
                                            {planet.motion_status === 'stationary_retrograde' && (
                                                <circle
                                                    cx={x}
                                                    cy={y - 8}
                                                    r="3"
                                                    fill="#fd7e14"
                                                    stroke="none"
                                                    style={{zIndex: zIndex + 1}}
                                                />
                                            )}
                                            
                                            {planet.motion_status === 'stationary_direct' && (
                                                <circle
                                                    cx={x}
                                                    cy={y - 8}
                                                    r="3"
                                                    fill="#20c997"
                                                    stroke="none"
                                                    style={{zIndex: zIndex + 1}}
                                                />
                                            )}
                                            
                                            {/* Posicionar glifo dentro del círculo */}
                                            <text
                                                x={x}
                                                y={y}
                                                textAnchor="middle"
                                                alignmentBaseline="middle"
                                                className="planet-label"
                                                style={{
                                                    fontSize: isSelected ? "18px" : "15px",
                                                    fontWeight: planet.name === 'VENUS' || planet.name === 'MARTE' ? 'bolder' : 'bold',
                                                    zIndex: zIndex + 2
                                                }}
                                            >
                                                {PLANET_SYMBOLS[planet.name]}
                                            </text>
                                            <title>{tooltipText}{planet.dignidad ? ` (${DIGNIDAD_LABELS[planet.dignidad]})` : ''}{planet.motion_status === 'retrograde' ? ' (Retrógrado)' : planet.motion_status === 'stationary_retrograde' ? ' (Estacionario Retrógrado)' : planet.motion_status === 'stationary_direct' ? ' (Estacionario Directo)' : ''}</title>
                                        </g>
                                    );
                                })}
                                
                                {/* Planetas de tránsitos */}
                                {showTransits && transitPlanets.length > 0 && transitPlanets
                                    // Ordenar los planetas en tránsito con el mismo orden
                                    .sort((a, b) => {
                                        // Definir el mismo orden de renderización
                                        const renderOrder = [
                                            'DSC', 'IC', 'PARTE_FORTUNA', 'PARTE_ESPIRITU', 'ASC', 'MC',
                                            'PLUTÓN', 'NEPTUNO', 'URANO', 'SATURNO', 'JÚPITER', 'MARTE',
                                            'MERCURIO', 'VENUS', 'SOL', 'LUNA'
                                        ];
                                        
                                        // Obtener la posición de cada planeta en el orden definido
                                        const indexA = renderOrder.indexOf(a.name);
                                        const indexB = renderOrder.indexOf(b.name);
                                        
                                        // Si ambos planetas están en la lista, ordenar según la posición
                                        if (indexA !== -1 && indexB !== -1) {
                                            return indexA - indexB;
                                        }
                                        
                                        // Para elementos no incluidos en renderOrder
                                        return 0;
                                    })
                                    .map((planet) => {
                                        const angle = (planet.longitude - 90) * Math.PI / 180;
                                        const x = DIMENSIONS.centerX + DIMENSIONS.middleRadius * Math.cos(angle);
                                        const y = DIMENSIONS.centerY + DIMENSIONS.middleRadius * Math.sin(angle);
                                        
                                        // Determinar si el planeta está involucrado en el aspecto seleccionado
                                        const isInSelectedAspect = selectedAspect && 
                                                                    selectedAspect.isInterChart && 
                                                                    selectedAspect.planet2 === planet.name;
                                        
                                        // No usamos adjustment porque queremos que los glifos estén dentro de sus círculos
                                        const isSelected = selectedPlanet === planet.name + '_transit' || isInSelectedAspect;
                                        const tooltipText = `${planet.name} (Tránsito) ${convertirGradosZodiacales(planet.longitude, planet.sign)} ${planet.sign}`;
                                        
                                        // Determinar el color del planeta con tonos pastel
                                        const planetColor = getPlanetColor(planet.name, planet.longitude);
                                        
                                        // Radio del círculo del planeta, más grande si está seleccionado
                                        const circleRadius = isSelected ? DIMENSIONS.planetCircleRadiusTransit + 2 : DIMENSIONS.planetCircleRadiusTransit;
                                        
                                        // Determinar z-index: puntos cardinales por debajo, planetas por encima
                                        const cardinalPoints = ['DSC', 'IC', 'PARTE_FORTUNA', 'PARTE_ESPIRITU', 'ASC', 'MC'];
                                        const baseZIndex = cardinalPoints.includes(planet.name) ? 1 : 2;
                                        const zIndex = isSelected ? baseZIndex + 10 : baseZIndex;
                                        
                                        return (
                                            <g 
                                                key={`transit_${planet.name}`}
                                                onClick={() => handlePlanetClick(planet.name + '_transit')}
                                                onMouseEnter={() => handlePlanetHover(planet)}
                                                onMouseLeave={handlePlanetLeave}
                                                style={{cursor: 'pointer'}}
                                            >
                                                {/* Círculo más grande para abarcar el glifo */}
                                                <circle
                                                    cx={x}
                                                    cy={y}
                                                    r={circleRadius}
                                                    fill={planetColor}
                                                    stroke="#000"
                                                    strokeWidth={isSelected ? "2" : "1"}
                                                    strokeDasharray="2,2"
                                                    className="transit-planet"
                                                    style={{zIndex: zIndex}}
                                                />
                                                
                                                {/* Indicador para planetas retrógrados */}
                                                {planet.motion_status === 'retrograde' && (
                                                    <circle
                                                        cx={x}
                                                        cy={y - 8}
                                                        r="3"
                                                        fill="#dc3545"
                                                        stroke="none"
                                                        style={{zIndex: zIndex + 1}}
                                                    />
                                                )}
                                                
                                                {/* Indicador para planetas estacionarios */}
                                                {planet.motion_status === 'stationary_retrograde' && (
                                                    <circle
                                                        cx={x}
                                                        cy={y - 8}
                                                        r="3"
                                                        fill="#fd7e14"
                                                        stroke="none"
                                                        style={{zIndex: zIndex + 1}}
                                                    />
                                                )}
                                                
                                                {planet.motion_status === 'stationary_direct' && (
                                                    <circle
                                                        cx={x}
                                                        cy={y - 8}
                                                        r="3"
                                                        fill="#20c997"
                                                        stroke="none"
                                                        style={{zIndex: zIndex + 1}}
                                                    />
                                                )}
                                                
                                                {/* Posicionar glifo dentro del círculo */}
                                                <text
                                                    x={x}
                                                    y={y}
                                                    textAnchor="middle"
                                                    alignmentBaseline="middle"
                                                    className="planet-label"
                                                    style={{
                                                        fontSize: isSelected ? "18px" : "15px",
                                                        fontWeight: planet.name === 'VENUS' || planet.name === 'MARTE' ? 'bolder' : 'bold',
                                                        zIndex: zIndex + 2
                                                    }}
                                                >
                                                    {PLANET_SYMBOLS[planet.name]}
                                                </text>
                                                <title>{tooltipText}{planet.dignidad ? ` (${DIGNIDAD_LABELS[planet.dignidad]})` : ''}{planet.motion_status === 'retrograde' ? ' (Retrógrado)' : planet.motion_status === 'stationary_retrograde' ? ' (Estacionario Retrógrado)' : planet.motion_status === 'stationary_direct' ? ' (Estacionario Directo)' : ''}</title>
                                            </g>
                                        );
                                    })}
                                </svg>
                        </div>
                        
                        {/* Panel de información del término */}
                        {termInfo && showTerms && (
                            <div className="term-info-panel">
                                <h4>Término para {termInfo.planetName} en {termInfo.sign}</h4>
                                <div className="term-info-content">
                                    <div className="term-color-sample" style={{backgroundColor: termInfo.termColor}}></div>
                                    <div>
                                        <strong>Regente:</strong> {termInfo.termPlanet} {termInfo.termSymbol}<br/>
                                        <strong>Grados:</strong> {termInfo.termDegrees}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Leyenda de términos */}
                        {renderTermsLegend()}
                        
                        {/* Información de planetas y estrellas debajo de la rueda */}
                        <div className="planets-panel">
                            {/* Columna 1: Planetas Natales */}
                            <div className="planets-column">
                                <h3>Planetas Natales</h3>
                                {planets.map(planet => {
                                    // CORRECCIÓN: Determinar si el planeta está involucrado en el aspecto seleccionado
                                    const isInSelectedAspect = selectedAspect && 
                                        ((selectedAspect.isInterChart && selectedAspect.planet1 === planet.name) || 
                                        (!selectedAspect.isInterChart && planetsInSelectedAspect.includes(planet.name)));
                                    
                                    // Determinar clase CSS para dignidad
                                    let dignityClass = '';
                                    if (planet.dignidad) {
                                        dignityClass = `dignity-${planet.dignidad}`;
                                    }
                                    
                                    // Determinar símbolo para retrógrado
                                    let retroSymbol = '';
                                    if (planet.motion_status === 'retrograde') {
                                        retroSymbol = ' <span class="retrograde">℞</span>';
                                    } else if (planet.motion_status === 'stationary_retrograde') {
                                        retroSymbol = ' <span class="stationary-retrograde">Sr</span>';
                                    } else if (planet.motion_status === 'stationary_direct') {
                                        retroSymbol = ' <span class="stationary-direct">Sd</span>';
                                    }
                                    
                                    return (
                                        <div 
                                            key={planet.name}
                                            className="planet-list-item"
                                            style={{
                                                backgroundColor: (selectedPlanet === planet.name || isInSelectedAspect) ? '#f0f0f0' : 'transparent',
                                                fontWeight: (selectedPlanet === planet.name || isInSelectedAspect) ? 'bold' : 'normal'
                                            }}
                                            onClick={() => handlePlanetClick(planet.name)}
                                        >
                                            <strong>{PLANET_SYMBOLS[planet.name]}</strong>
                                            <span dangerouslySetInnerHTML={{__html: retroSymbol}} />
                                            {': '} 
                                            {planet.sign} {convertirGradosZodiacales(planet.longitude, planet.sign)} 
                                            {planet.house !== undefined && ` - Casa ${planet.house}`} 
                                            <span className={dignityClass}>{planet.dignidad ? ` (${DIGNIDAD_LABELS[planet.dignidad]})` : ''}</span>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Columna 2: Planetas en Tránsito (si están activos) */}
                            {showTransits && transitPlanets.length > 0 ? (
                                <div className="planets-column">
                                    <h3>Planetas en Tránsito</h3>
                                    {transitPlanets.map(planet => {
                                        // Determinar si el planeta está involucrado en el aspecto seleccionado
                                        const isInSelectedAspect = selectedAspect && 
                                                                selectedAspect.isInterChart && 
                                                                selectedAspect.planet2 === planet.name;
                                        
                                        // Determinar clase CSS para dignidad
                                        let dignityClass = '';
                                        if (planet.dignidad) {
                                            dignityClass = `dignity-${planet.dignidad}`;
                                        }
                                        
                                        // Determinar símbolo para retrógrado
                                        let retroSymbol = '';
                                        if (planet.motion_status === 'retrograde') {
                                            retroSymbol = ' <span class="retrograde">℞</span>';
                                        } else if (planet.motion_status === 'stationary_retrograde') {
                                            retroSymbol = ' <span class="stationary-retrograde">Sr</span>';
                                        } else if (planet.motion_status === 'stationary_direct') {
                                            retroSymbol = ' <span class="stationary-direct">Sd</span>';
                                        }
                                        
                                        return (
                                            <div 
                                                key={`transit_${planet.name}`}
                                                className="planet-list-item"
                                                style={{
                                                    backgroundColor: (selectedPlanet === planet.name + '_transit' || isInSelectedAspect) ? '#f0f0f0' : 'transparent',
                                                    fontWeight: (selectedPlanet === planet.name + '_transit' || isInSelectedAspect) ? 'bold' : 'normal'
                                                }}
                                                onClick={() => handlePlanetClick(planet.name + '_transit')}
                                            >
                                                <strong>{PLANET_SYMBOLS[planet.name]}</strong>
                                                <span dangerouslySetInnerHTML={{__html: retroSymbol}} />
                                                {': '} 
                                                {planet.sign} {convertirGradosZodiacales(planet.longitude, planet.sign)} 
                                                <span className={dignityClass}>{planet.dignidad ? ` (${DIGNIDAD_LABELS[planet.dignidad]})` : ''}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : null}
                            
                            {/* Columna 3: Estrellas Fijas */}
                            <div className="planets-column">
                                <h3>Estrellas Fijas</h3>
                                {(showTransits ? transitActiveStars : activeStars).length > 0 ? 
                                    (showTransits ? transitActiveStars : activeStars).map((star, index) => {
                                        // ACTUALIZADO: Usar el ayanamsa del servidor para las estrellas fijas
                                        const currentLongitude = getCurrentStarPosition(
                                            star, 
                                            showTransits ? transitDate : date, 
                                            useSiderealZodiac, 
                                            serverAyanamsa
                                        );
                                        // ACTUALIZADO: Pasar el ayanamsa a findConjunctPlanets
                                        const conjunctPlanets = findConjunctPlanets(
                                            star, 
                                            showTransits ? transitPlanets : planets, 
                                            showTransits ? transitDate : date, 
                                            useSiderealZodiac, 
                                            serverAyanamsa
                                        );
                                        return (
                                            <div 
                                                key={`${showTransits ? 'transit-' : ''}star-${index}`}
                                                className="planet-list-item"
                                                onClick={() => handleStarClick(star)}
                                                style={{cursor: 'pointer'}}
                                            >
                                                <span className="star-symbol">★</span> {star.name} ({currentLongitude.toFixed(2)}°)
                                                <br/>
                                                <small>
                                                    Conjunción con: {conjunctPlanets.map(p => 
                                                        `${PLANET_SYMBOLS[p.name]} (${p.diff}°)`
                                                    ).join(', ')}
                                                </small>
                                            </div>
                                        );
                                    })
                                    :
                                    <div>No hay estrellas fijas en conjunción con planetas.</div>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div className="right-section">
                        {/* Mostrar aspectos relevantes */}
                        <div className="aspects-container">
                            <h3>Aspectos {showTransits ? 'Tránsito/Natal' : 'Relevantes'}</h3>
                            {showTransits ? 
                                // Mostrar aspectos entre tránsitos y carta natal
                                relevantInterChartAspects.map((aspect, index) => {
                                    const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                                    
                                    // Destacar aspectos cuando el planeta está seleccionado
                                    const isHighlighted = 
                                        selectedAspect === aspect || 
                                        (selectedPlanet === aspect.planet1) || 
                                        (transitPlanetName === aspect.planet2);
                                    
                                    // Texto especial si es el mismo planeta
                                    const aspectText = aspect.isSamePlanet 
                                        ? `${PLANET_SYMBOLS[aspect.planet1]} (natal) ${aspectName} ${PLANET_SYMBOLS[aspect.planet2]} (mismo en tránsito) (${aspect.angle.toFixed(2)}°)`
                                        : `${PLANET_SYMBOLS[aspect.planet1]} (natal) ${aspectName} ${PLANET_SYMBOLS[aspect.planet2]} (tránsito) (${aspect.angle.toFixed(2)}°)`;
                                    
                                    return (
                                        <div 
                                            key={`inter-aspect-${index}`} 
                                            className="aspect-list-item"
                                            style={{
                                                backgroundColor: isHighlighted ? '#f0f0f0' : 'transparent',
                                                fontWeight: isHighlighted ? 'bold' : 'normal'
                                            }}
                                            onClick={() => handleAspectClick(aspect)}
                                        >
                                            {aspectText}
                                        </div>
                                    );
                                })
                                : 
                                // Mostrar aspectos de la carta natal
                                relevantAspects.map((aspect, index) => {
                                    const planet1 = planets.find(p => p.name === aspect.planet1);
                                    const planet2 = planets.find(p => p.name === aspect.planet2);
                                    
                                    if (!planet1 || !planet2) return null;
                                    
                                    const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                                    const isHighlighted = selectedAspect === aspect || 
                                        (selectedPlanet && (aspect.planet1 === selectedPlanet || aspect.planet2 === selectedPlanet));
                                    
                                    // Texto especial si es el mismo planeta (aunque en carta natal es poco común)
                                    const aspectText = aspect.isSamePlanet 
                                        ? `${PLANET_SYMBOLS[aspect.planet1]} ${aspect.instance1_info || ''} ${aspectName} ${PLANET_SYMBOLS[aspect.planet2]} ${aspect.instance2_info || ''} (${aspect.angle.toFixed(2)}°)`
                                        : `${PLANET_SYMBOLS[aspect.planet1]} ${aspectName} ${PLANET_SYMBOLS[aspect.planet2]} (${aspect.angle.toFixed(2)}°)`;
                                    
                                    return (
                                        <div 
                                            key={`aspect-desc-${index}`} 
                                            className="aspect-list-item"
                                            style={{
                                                backgroundColor: isHighlighted ? '#f0f0f0' : 'transparent',
                                                fontWeight: isHighlighted ? 'bold' : 'normal'
                                            }}
                                            onClick={() => handleAspectClick(aspect)}
                                        >
                                            {aspectText}
                                        </div>
                                    );
                                })
                            }
                        </div>

                        {/* Sección de interpretaciones */}
                        <div className="interpretations-container">
                            {/* Pestañas para cambiar entre natal y tránsitos */}
                            {showTransits && transitPlanets.length > 0 ? (
                                <div className="tab-container">
                                    <div 
                                        className={`tab ${activeTab === 'natal' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('natal')}
                                    >
                                        Carta Natal
                                    </div>
                                    <div 
                                        className={`tab ${activeTab === 'transit' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('transit')}
                                    >
                                        Tránsitos
                                    </div>
                                </div>
                            ) : null}
                            
                            {/* Interpretaciones de la carta natal */}
                            {(!showTransits || activeTab === 'natal') && interpretations && (
                                <>
                                    <div className="interpretation-section">
                                        <h3>Planetas en Signos</h3>
                                        {interpretations.planets_in_signs.map((interp, index) => (
                                            <div key={`sign-${index}`} className="interpretation-item">
                                                <div className="interpretation-title">
                                                    {PLANET_SYMBOLS[interp.planet]} en {interp.sign}
                                                </div>
                                                {interp.interpretation.physical && (
                                                    <div className="physical-plane">
                                                        <div className="plane-title">Plano Físico:</div>
                                                        <div className="interpretation-content">
                                                            {interp.interpretation.physical}
                                                        </div>
                                                    </div>
                                                )}
                                                {interp.interpretation.astral && (
                                                    <div className="astral-plane">
                                                        <div className="plane-title">Plano Astral:</div>
                                                        <div className="interpretation-content">
                                                            {interp.interpretation.astral}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="interpretation-section">
                                        <h3>Planetas en Casas</h3>
                                        {interpretations.planets_in_houses.map((interp, index) => (
                                            <div key={`house-${index}`} className="interpretation-item">
                                                <div className="interpretation-title">
                                                    {PLANET_SYMBOLS[interp.planet]} en Casa {interp.house}
                                                </div>
                                                <div className="interpretation-content">{interp.interpretation}</div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="interpretation-section">
                                        <h3>Aspectos</h3>
                                        {interpretations.aspects.map((interp, index) => (
                                            <div key={`aspect-${index}`} className="interpretation-item">
                                                <div className="interpretation-title">
                                                    {interp.planets} - {interp.type}
                                                </div>
                                                <div className="interpretation-content">{interp.interpretation}</div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="interpretation-section">
                                        <h3>Regentes de Casas</h3>
                                        {interpretations.house_rulers.map((interp, index) => (
                                            <div key={`ruler-${index}`} className="interpretation-item">
                                                <div className="interpretation-title">
                                                    Regente {interp.ruler_type} de Casa {interp.house} ({interp.ruler}) 
                                                    en Casa {interp.ruler_house}
                                                </div>
                                                <div className="interpretation-content">{interp.interpretation}</div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                            
                            {/* Interpretaciones de tránsitos - añadido interpretaciones de casas */}
                            {showTransits && activeTab === 'transit' && transitInterpretations && (
                                <>
                                    <div className="interpretation-section">
                                        <h3>Planetas en Tránsito en Signos</h3>
                                        {transitInterpretations.planets_in_signs.map((interp, index) => (
                                            <div key={`transit-sign-${index}`} className="interpretation-item">
                                                <div className="interpretation-title">
                                                    {PLANET_SYMBOLS[interp.planet]} en {interp.sign} (Tránsito)
                                                </div>
                                                {interp.interpretation.physical && (
                                                    <div className="physical-plane">
                                                        <div className="plane-title">Plano Físico:</div>
                                                        <div className="interpretation-content">
                                                            {interp.interpretation.physical}
                                                        </div>
                                                    </div>
                                                )}
                                                {interp.interpretation.astral && (
                                                    <div className="astral-plane">
                                                        <div className="plane-title">Plano Astral:</div>
                                                        <div className="interpretation-content">
                                                            {interp.interpretation.astral}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* Nueva sección: Planetas en tránsito en casas natales */}
                                    <div className="interpretation-section">
                                        <h3>Planetas en Tránsito en Casas</h3>
                                        {transitInterpretations.planets_in_houses.map((interp, index) => (
                                            <div key={`transit-house-${index}`} className="interpretation-item">
                                                <div className="interpretation-title">
                                                    {PLANET_SYMBOLS[interp.planet]} en Casa {interp.house} (Tránsito)
                                                </div>
                                                <div className="interpretation-content">{interp.interpretation}</div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Esta función es necesaria para mostrar los grados dentro del signo
function convertirGradosZodiacales(longitud, signo) {
    // Definición de los límites de cada signo
    const limites = {
        "ARIES": { inicio: 354, fin: 30, cruza0: true },
        "TAURO": { inicio: 30, fin: 60, cruza0: false },
        "GÉMINIS": { inicio: 60, fin: 90, cruza0: false },
        "CÁNCER": { inicio: 90, fin: 120, cruza0: false },
        "LEO": { inicio: 120, fin: 150, cruza0: false },
        "VIRGO": { inicio: 150, fin: 186, cruza0: false },
        "LIBRA": { inicio: 186, fin: 210, cruza0: false },
        "ESCORPIO": { inicio: 210, fin: 240, cruza0: false },
        "OFIUCO": { inicio: 240, fin: 252, cruza0: false },
        "SAGITARIO": { inicio: 252, fin: 270, cruza0: false },
        "CAPRICORNIO": { inicio: 270, fin: 306, cruza0: false },
        "ACUARIO": { inicio: 306, fin: 324, cruza0: false },
        "PEGASO": { inicio: 324, fin: 330, cruza0: false },
        "PISCIS": { inicio: 330, fin: 354, cruza0: false }
    };
    
    // Verificar si el signo existe en nuestro diccionario
    if (!limites[signo]) {
        return "0° 00'";
    }
    
    const limite = limites[signo];
    longitud = parseFloat(longitud) % 360;
    
    // Calcular los grados dentro del signo
    let gradosEnSigno;
    
    // Caso especial para Aries que cruza 0°
    if (limite.cruza0 && longitud < limite.inicio && longitud < limite.fin) {
        // Caso especial: Aries cuando la longitud está entre 0° y 30°
        gradosEnSigno = longitud + (360 - limite.inicio);
    } else if (limite.cruza0 && longitud >= limite.inicio) {
        // Caso especial: Aries cuando la longitud está entre 354° y 360°
        gradosEnSigno = longitud - limite.inicio;
    } else {
        // Caso normal para otros signos
        gradosEnSigno = longitud - limite.inicio;
    }
    
    // Asegurarse de que los grados están dentro del rango correcto
    if (gradosEnSigno < 0) gradosEnSigno += 360;
    
    // Convertir a grados y minutos
    const grados = Math.floor(gradosEnSigno);
    const minutos = Math.floor((gradosEnSigno - grados) * 60);
    
    // Devolver en formato "X° YY'"
    return `${grados}° ${minutos.toString().padStart(2, '0')}'`;
}

console.log("Script iniciando...");

// Verificar que React está cargado
console.log("React:", typeof React);
console.log("ReactDOM:", typeof ReactDOM);

// Verificar que el elemento root existe
const rootElement = document.getElementById("root");
console.log("Elemento root:", rootElement);

// Siempre crear un nuevo root y renderizar
console.log("Creando nuevo root de React...");
try {
    const root = ReactDOM.createRoot(rootElement);
    console.log("Renderizando App...");
    root.render(<App />);
    console.log("App renderizada");
} catch (error) {
    console.error("Error al renderizar App:", error);
}
    </script>
</body>
</html>
getPlanetTerm  